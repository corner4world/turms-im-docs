import{_ as n,E as o,c as r,J as a,V as s,m as e,a as t,o as l}from"./chunks/framework.fogKwqBf.js";const D=JSON.parse('{"title":"Identity and Access Management","description":"","frontmatter":{},"headers":[],"relativePath":"server/module/identity-access-management.md","filePath":"server/module/identity-access-management.md"}'),d={name:"server/module/identity-access-management.md"},h=s('<h1 id="identity-and-access-management" tabindex="-1">Identity and Access Management <a class="header-anchor" href="#identity-and-access-management" aria-label="Permalink to &quot;Identity and Access Management&quot;">​</a></h1><h2 id="login-authentication-and-authorization" tabindex="-1">Login Authentication and Authorization <a class="header-anchor" href="#login-authentication-and-authorization" aria-label="Permalink to &quot;Login Authentication and Authorization&quot;">​</a></h2><p>Turms not only provides a built-in identity and access management mechanism, but also supports user-defined identity and access management implementation based on plug-ins.</p><h3 id="related-configuration" tabindex="-1">Related configuration <a class="header-anchor" href="#related-configuration" aria-label="Permalink to &quot;Related configuration&quot;">​</a></h3><table><thead><tr><th>Property</th><th>Default Value</th><th>Description</th></tr></thead><tbody><tr><td>turms.gateway.session.identity-access-management.enabled</td><td>true</td><td>Whether to enable the identity and access management mechanism. <br>If the value is <code>false</code>, turn off the Turms built-in identity and access management mechanism and user-based plug-in custom identity and access management implementation, and allow any user to log in, and authorize them to send any type of request</td></tr><tr><td>turms.gateway.session.identity-access-management.type</td><td>password</td><td>The type of Turms built-in identity and access management mechanism used. The type can be <code>noop</code>, <code>password</code>, <code>jwt</code>, <code>http</code> and <code>ldap</code>. See below for details</td></tr></tbody></table><h3 id="built-in-identity-and-access-management-mechanism" tabindex="-1">Built-in identity and access management mechanism <a class="header-anchor" href="#built-in-identity-and-access-management-mechanism" aria-label="Permalink to &quot;Built-in identity and access management mechanism&quot;">​</a></h3><h4 id="_1-noop" tabindex="-1">1. NOOP <a class="header-anchor" href="#_1-noop" aria-label="Permalink to &quot;1. NOOP&quot;">​</a></h4><p>Turn off the built-in identity and access management mechanism, and allow any user to log in, and authorize it to send any request type.</p><h5 id="related-properties" tabindex="-1">Related Properties <a class="header-anchor" href="#related-properties" aria-label="Permalink to &quot;Related Properties&quot;">​</a></h5><ul><li>turms.gateway.session.identity-access-management.type=noop</li></ul><h4 id="_2-password-based-authentication" tabindex="-1">2. Password-based authentication <a class="header-anchor" href="#_2-password-based-authentication" aria-label="Permalink to &quot;2. Password-based authentication&quot;">​</a></h4><p>User authentication is based on the password in the <code>user</code> collection in the MongoDB built by the Turms server. Authorization implementation is not currently supported.</p><h5 id="related-properties-1" tabindex="-1">Related Properties <a class="header-anchor" href="#related-properties-1" aria-label="Permalink to &quot;Related Properties&quot;">​</a></h5><ul><li>turms.gateway.session.identity-access-management.type=password</li></ul><h4 id="_3-jwt-based-authentication" tabindex="-1">3. JWT-based Authentication <a class="header-anchor" href="#_3-jwt-based-authentication" aria-label="Permalink to &quot;3. JWT-based Authentication&quot;">​</a></h4><p>The JWT token contains the user&#39;s authentication and authorization information.</p><h5 id="workflow" tabindex="-1">Workflow <a class="header-anchor" href="#workflow" aria-label="Permalink to &quot;Workflow&quot;">​</a></h5>',17),c=s(`<ul><li>The client application applies for a JWT token from your server</li><li>After the client application gets the JWT token, it sends the JWT string to the turms-gateway server through the <code>password</code> field in the Turms client login interface <code>turmsClient.userService.login</code></li><li>After the turms-gateway server gets the JWT token, according to the algorithm specified in the JWT token and the public key configuration configured by the developer on the turms-gateway server (asymmetric encryption algorithm: RS256, RS384, RS512, PS256, PS384 , PS512, ES256, ES384, ES512) or private key configuration (symmetric encryption algorithm: HS256, HS384, HS512) to verify the JWT token.</li><li>If the developer does not configure the algorithm key configuration specified by JWT on the turms-gateway server, a corresponding error message will be returned to the client to inform the client that the algorithm is not supported</li><li>If the JWT token verification is passed, the user is authenticated and authorized according to the authentication and authorization information of the JWT token</li><li>If the JWT token verification fails, return the corresponding error message to the client</li></ul><h5 id="jwt-body-payload-format" tabindex="-1">JWT body (Payload) format <a class="header-anchor" href="#jwt-body-payload-format" aria-label="Permalink to &quot;JWT body (Payload) format&quot;">​</a></h5><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">     &quot;iss&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// issuer</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">     &quot;sub&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// subject</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">     &quot;aud&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">array&lt;string&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// audience</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">     &quot;exp&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// expiration time</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">     &quot;nbf&quot;</span><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">,</span><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> number,</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // not before</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">     &quot;authenticated&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">     &quot;statements&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">         &quot;effect&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ALLOW&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// or &quot;DENY&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">         &quot;actions&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;*&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// a string of [&quot;*&quot;, &quot;CREATE&quot;, &quot;DELETE&quot;, &quot;UPDATE&quot;, &quot;QUERY&quot;], or an array that contains these strings</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">         &quot;resources&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;*&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // a string of [&quot;*&quot;, &quot;USER&quot;, &quot;GROUP_BLOCKED_USER&quot;, ...], or an array that contains these strings</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">     }]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>in:</p><ul><li><p>The five JWT public statements <code>iss</code>, <code>sub</code>, <code>aud</code>, <code>exp</code> and <code>nbf</code> can be used for JWT verification. Except for the <code>sub</code> statement that must exist, the other four statements can not exist. That is, no logical verification related to the statement is performed.</p><ul><li><p><code>iss</code> (issuer): The issuer of the JWT, such as <code>www.my-server.com</code>. It can be verified with the configuration item <code>turms.gateway.session.identity-access-management.jwt.verification.issuer</code>.</p></li><li><p><code>sub</code> (subject): The user the JWT is issued to, such as <code>123456789</code>. This field must be the same as the user&#39;s login user ID.</p></li><li><p><code>aud</code> (audience): The recipient of the JWT, such as <code>www.my-turms.com</code>. It can be verified with the configuration item <code>turms.gateway.session.identity-access-management.jwt.verification.audience</code>.</p></li><li><p><code>exp</code> (expiration time): JWT expiration time, such as <code>1600000000</code>. After that time, the JWT is invalid.</p></li><li><p><code>nbf</code> (not before): Before this time, the JWT is invalid, such as <code>1600000000</code>.</p></li></ul></li><li><p><code>authenticated</code>: private boolean statement, indicating whether the user is authenticated, if it is <code>true</code> (note: the <code>true</code> can be either a boolean value or a string), it means the authentication is passed, otherwise it is not passed.</p></li><li><p><code>statements</code>: Private array statement, indicating the permissions of the user, the maximum length of the array is 100.</p><ul><li><p>The <code>effect</code> field can be <code>ALLOW</code> for &quot;allowed permissions&quot;, or <code>DENY</code> for &quot;forbidden permissions&quot;. The priority of permissions prohibited by <code>DENY</code> is always higher than that allowed by <code>ALLOW</code>, and will not be affected by the declaration order of <code>statements</code>.</p><p><code>DENY</code> is usually used together with <code>ALLOW</code>, such as permission &quot;All permissions are allowed except CREATE USER and GROUP_BLOCKED_USER resource permissions are prohibited&quot;:</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;effect&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;DENY&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;actions&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;CREATE&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;resources&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;USER&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;GROUP_BLOCKED_USER&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}, {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;effect&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ALLOW&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;actions&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;*&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;resources&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;*&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}]</span></span></code></pre></div></li><li><p>The <code>actions</code> field represents the authorized behavior, and its value can be either the following string or an array containing the following strings, such as <code>[&quot;CREATE&quot;, &quot;DELETE&quot;]</code>:</p><ul><li><code>*</code>: all actions</li><li><code>CREATE</code>: create behavior</li><li><code>DELETE</code>: delete behavior</li><li><code>UPDATE</code>: update behavior</li><li><code>QUERY</code>: query behavior</li></ul></li><li><p>The <code>resources</code> field indicates authorized resources (that is, whether the user has permission to send requests related to these resources), and its value can be either the following string or an array containing the following strings, such as <code>[&quot;USER &quot;, &quot;MESSAGE&quot;]</code>:</p><ul><li><code>*</code>: all resources</li><li><code>USER</code>: user data related resources</li><li><code>USER_LOCATION</code>: user location related resources</li><li><code>USER_ONLINE_STATUS</code>: resources related to user online status</li><li><code>USER_PROFILE</code>: resources related to user personal information</li><li><code>NEARBY_USER</code>: Nearby user related resources</li><li><code>RELATIONSHIP</code>: user relationship related resources</li><li><code>RELATIONSHIP_GROUP</code>: user relationship group related resources</li><li><code>FRIEND_REQUEST</code>: Friends request related resources</li><li><code>GROUP</code>: group information related resources</li><li><code>GROUP_BLOCKED_USER</code>: Group blocked user related resources</li><li><code>GROUP_INVITATION</code>: Group invitation related resources</li><li><code>GROUP_JOIN_QUESTION</code>: resources related to joining group questions</li><li><code>GROUP_JOIN_QUESTION_ANSWER</code>: Relevant resources for joining group questions and answers</li><li><code>GROUP_JOIN_REQUEST</code>: Join the group to request related resources</li><li><code>GROUP_MEMBER</code>: resources related to group members</li><li><code>JOINED_GROUP</code>: related resources of the joined group</li><li><code>MESSAGE</code>: message related resources</li><li><code>CONVERSATION</code>: session-related resources</li><li><code>TYPING_STATUS</code>: input status related resources</li><li><code>RESOURCE</code>: storage resource related resources</li></ul></li></ul></li></ul><h5 id="related-properties-2" tabindex="-1">Related Properties <a class="header-anchor" href="#related-properties-2" aria-label="Permalink to &quot;Related Properties&quot;">​</a></h5>`,6),u=e("table",null,[e("thead",null,[e("tr",null,[e("th",null,"Property"),e("th",null,"Default Value"),e("th",null,"Description")])]),e("tbody",null,[e("tr",null,[e("td",null,"turms.gateway.session.identity-access-management.type"),e("td",null,"password"),e("td",null,[t("Set to "),e("code",null,"jwt"),t(" to enable JWT-based identity and access management")])]),e("tr",null,[e("td",null,"turms.service.message.check-if-target-active-and-not-deleted"),e("td",null,"true"),e("td",null,[t("When using the "),e("code",null,"JWT"),t(" mechanism, you need to set this configuration item to "),e("code",null,"false"),t(", otherwise because it does not exist in the Turms database the user, so the user will not be able to send messages")])]),e("tr",null,[e("td",null,"turms.gateway.session.identity-access-management.jwt.verification.issuer"),e("td"),e("td",null,"When the value is not empty, verify whether the issuer of the JWT is equal to this value")]),e("tr",null,[e("td",null,"turms.gateway.session.identity-access-management.jwt.verification.audience"),e("td"),e("td",null,"When the value is not empty, verify whether the receiver of the JWT contains this value")]),e("tr",null,[e("td",null,"turms.gateway.session.identity-access-management.jwt.verification.custom-payload-claims"),e("td"),e("td",null,"When the value is not empty, verify that the private claims in the JWT match this value")]),e("tr",null,[e("td",null,"turms.gateway.session.identity-access-management.jwt.authentication.expectation.custom-payload-claims"),e("td",{"authenticated:":"",true:""}),e("td",null,"Match this value in the JWT's private claim, if the match is successful, it indicates that the User has been authenticated")]),e("tr",null,[e("td",null,"turms.gateway.session.identity-access-management.jwt.algorithm.hmac256.file-path"),e("td"),e("td",null,"key file path. Developers only need to configure this key or a group in P12 below")]),e("tr",null,[e("td",null,"turms.gateway.session.identity-access-management.jwt.algorithm.hmac256.p12.file-path"),e("td"),e("td",null,"PKCS#12 file path")]),e("tr",null,[e("td",null,"turms.gateway.session.identity-access-management.jwt.algorithm.hmac256.p12.password"),e("td"),e("td",null,"PKCS#12 key")]),e("tr",null,[e("td",null,"turms.gateway.session.identity-access-management.jwt.algorithm.hmac256.p12.key-alias"),e("td"),e("td",null,"key alias")]),e("tr",null,[e("td",null,"turms.gateway.session.identity-access-management.jwt.algorithm.hmac256.p12.key-password"),e("td"),e("td",null,"key password. When empty, it defaults to the PKCS#12 key")]),e("tr",null,[e("td",null,"turms.gateway.session.identity-access-management.jwt.algorithm.rsa256.pem-file-path"),e("td"),e("td",null,"PEM file path. Developers only need to configure the PEM or a set of P12 below")]),e("tr",null,[e("td",null,"turms.gateway.session.identity-access-management.jwt.algorithm.rsa256.p12.file-path"),e("td"),e("td",null,"PKCS#12 file path")]),e("tr",null,[e("td",null,"turms.gateway.session.identity-access-management.jwt.algorithm.rsa256.p12.password"),e("td"),e("td",null,"PKCS#12 key")]),e("tr",null,[e("td",null,"turms.gateway.session.identity-access-management.jwt.algorithm.rsa256.p12.key-alias"),e("td"),e("td",null,"public key alias")]),e("tr",null,[e("td",null,[t("The configuration of rsa384/rsa512/ps256/ps384/ps512/ecdsa256/ecdsa384/ecdsa512 is the same as the above "),e("code",null,"rsa256")]),e("td"),e("td")])])],-1),p=e("h4",{id:"_4-identity-and-access-management-mechanism-based-on-external-http-response",tabindex:"-1"},[t("4. Identity and access management mechanism based on external HTTP response "),e("a",{class:"header-anchor",href:"#_4-identity-and-access-management-mechanism-based-on-external-http-response","aria-label":'Permalink to "4. Identity and access management mechanism based on external HTTP response"'},"​")],-1),m=e("p",null,"The HTTP response contains the user's authentication and authorization information.",-1),k=e("h5",{id:"workflow-1",tabindex:"-1"},[t("Workflow "),e("a",{class:"header-anchor",href:"#workflow-1","aria-label":'Permalink to "Workflow"'},"​")],-1),g=s(`<ul><li><p>The client sends a login request to the turms-gateway server through the Turms client login interface <code>turmsClient.userService.login</code></p></li><li><p>The turms-gateway server will send an HTTP request to your HTTP server, and the format of the request body is:</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;version&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;userId&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;password&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;loggingInDeviceType&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;deviceDetails&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;userStatus&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;location&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;ip&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">string</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div></li><li><p>Your HTTP server returns the user&#39;s authentication and authorization information according to the &quot;HTTP Response Format&quot; below</p></li><li><p>turms-gateway authenticates and authorizes users based on the HTTP response</p></li></ul><h5 id="http-response-format" tabindex="-1">HTTP response format <a class="header-anchor" href="#http-response-format" aria-label="Permalink to &quot;HTTP response format&quot;">​</a></h5><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">     &quot;authenticated&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">     &quot;statements&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">         &quot;effect&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ALLOW&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// or &quot;DENY&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">         &quot;actions&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;*&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// a string of [&quot;*&quot;, &quot;CREATE&quot;, &quot;DELETE&quot;, &quot;UPDATE&quot;, &quot;QUERY&quot;], or an array that contains these strings</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">         &quot;resources&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;*&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // a string of [&quot;*&quot;, &quot;USER&quot;, &quot;GROUP_BLOCKED_USER&quot;, ...], or an array that contains these strings</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">     }]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>The meanings of <code>authenticated</code> and <code>statements</code> fields are the same as those of the corresponding statements in the JWT text above, so I won’t repeat them here.</p><h5 id="related-properties-3" tabindex="-1">Related Properties <a class="header-anchor" href="#related-properties-3" aria-label="Permalink to &quot;Related Properties&quot;">​</a></h5>`,5),y=e("table",null,[e("thead",null,[e("tr",null,[e("th",null,"Property"),e("th",null,"Default Value"),e("th",null,"Description")])]),e("tbody",null,[e("tr",null,[e("td",null,"turms.gateway.session.identity-access-management.type"),e("td",null,"password"),e("td",null,[t("Set to "),e("code",null,"http"),t(" to enable identity and access management based on external HTTP responses")])]),e("tr",null,[e("td",null,"turms.service.message.check-if-target-active-and-not-deleted"),e("td",null,"true"),e("td",null,[t("When using the "),e("code",null,"HTTP"),t(" mechanism, you need to set this configuration item to "),e("code",null,"false"),t(", otherwise because it does not exist in the Turms database the user, so the user will not be able to send messages")])]),e("tr",null,[e("td",null,"turms.gateway.session.identity-access-management.http.request.url"),e("td",null,'""'),e("td",null,"Request URL")]),e("tr",null,[e("td",null,"turms.gateway.session.identity-access-management.http.request.headers"),e("td",null,"true"),e("td",null,"additional request headers")]),e("tr",null,[e("td",null,"turms.gateway.session.identity-access-management.http.request.http-method"),e("td",null,"GET"),e("td",null,"request method")]),e("tr",null,[e("td",null,"turms.gateway.session.identity-access-management.http.request.timeout-millis"),e("td",null,"30000"),e("td",null,"Request timeout")]),e("tr",null,[e("td",null,"turms.gateway.session.identity-access-management.http.authentication.response-expectation.status-codes"),e("td",null,'"2??"'),e("td",null,"Match this value in the response status code, if the match is successful, continue to other matches, Otherwise authentication fails")]),e("tr",null,[e("td",null,"turms.gateway.session.identity-access-management.http.authentication.response-expectation.headers"),e("td"),e("td",null,"Match the value in the response header, if the match is successful, continue to other matches, otherwise the authentication fails")]),e("tr",null,[e("td",null,"turms.gateway.session.identity-access-management.http.authentication.response-expectation.body-fields"),e("td",{"authenticated:":"",true:""}),e("td",null,"Match this value in the response body, if the match is successful, continue with other matches , otherwise authentication fails")])])],-1),E=e("h4",{id:"_5-ldap-based-authentication",tabindex:"-1"},[t("5. LDAP-based Authentication "),e("a",{class:"header-anchor",href:"#_5-ldap-based-authentication","aria-label":'Permalink to "5. LDAP-based Authentication"'},"​")],-1),f=e("h5",{id:"workflow-2",tabindex:"-1"},[t("Workflow "),e("a",{class:"header-anchor",href:"#workflow-2","aria-label":'Permalink to "Workflow"'},"​")],-1),q=s('<ol><li><p>The client sends a login request to the turms-gateway server through the Turms client login interface <code>turmsClient.userService.login</code>.</p></li><li><p>Upon receiving the login request from the client, the turms-gateway will use the <code>userId</code> parameter from the login request, along with the properties configured in the turms-gateway system (such as <code>baseDn</code> and <code>searchFilter</code> mentioned later in this document) to construct a search request to LDAP, in order to search the user&#39;s DN corresponding to the <code>userId</code>.</p></li><li><p>When the turms-gateway receives the search result from LDAP, it will verify the number of entries in the search result:</p><ol><li>If the number is 0, it indicates that the account does not exist, and as a result, the client will receive an unauthorized response.</li><li>If the number is 1, it indicates that the <code>userId</code> in the user&#39;s login request matches a corresponding DN. The turms-gateway will use this user&#39;s DN and the <code>password</code> parameter from the user&#39;s login request to send a bind login to the LDAP server: <ol><li>If the result code is 49 (invalid credentials), the client will receive an unauthorized response.</li><li>If the result code is 0 (successful login), the client will receive an authorized response.</li><li>If it is any other result code, the client will receive a system internal error response.</li></ol></li><li>If the number is greater than 1, it indicates an error in the system-configured <code>searchFilter</code> property, requiring reconfiguration, and as a result, the system will respond with an internal error.</li></ol><p><strong>Note: The Turms user ID for an LDAP user is configured by the LDAP system administrator and is not configured by the Turms server. It is required that this value must be greater than 0, with no other conditions imposed.</strong></p></li></ol><h5 id="related-properties-4" tabindex="-1">Related Properties <a class="header-anchor" href="#related-properties-4" aria-label="Permalink to &quot;Related Properties&quot;">​</a></h5><table><thead><tr><th>Property</th><th>Default Value</th><th>Description</th></tr></thead><tbody><tr><td>turms.gateway.session.identity-access-management.type</td><td>password</td><td>Set to <code>ldap</code> to enable LDAP-based identity and access management</td></tr><tr><td>turms.gateway.session.identity-access-management.ldap.base-dn</td><td>&quot;&quot;</td><td>Base DN. For example, <code>dc=turms,dc=im</code></td></tr><tr><td>turms.gateway.session.identity-access-management.ldap.admin.host</td><td>localhost</td><td>LDAP server host for administrative operations</td></tr><tr><td>turms.gateway.session.identity-access-management.ldap.admin.port</td><td>389</td><td>LDAP server port for administrative operations</td></tr><tr><td>turms.gateway.session.identity-access-management.ldap.admin.ssl....</td><td></td><td>SSL-related properties for administrative operations in LDAP</td></tr><tr><td>turms.gateway.session.identity-access-management.ldap.admin.username</td><td>&quot;&quot;</td><td>Administrator username</td></tr><tr><td>turms.gateway.session.identity-access-management.ldap.admin.password</td><td>&quot;&quot;</td><td>Administrator password</td></tr><tr><td>turms.gateway.session.identity-access-management.ldap.user.host</td><td>localhost</td><td>LDAP server address for user-related operations</td></tr><tr><td>turms.gateway.session.identity-access-management.ldap.user.port</td><td>389</td><td>LDAP server port for user-related operations</td></tr><tr><td>turms.gateway.session.identity-access-management.ldap.user.ssl....</td><td></td><td>SSL-related properties for user-related operations in LDAP</td></tr><tr><td>turms.gateway.session.identity-access-management.ldap.user.search-filter</td><td>&quot;uid=${userId}&quot;</td><td>Search filter. The turms-gateway matches the corresponding user DN in the LDAP system based on this search filter. <code>${userId}</code> is the user ID placeholder, which will be replaced with the <code>userId</code> from the user&#39;s login request when the filter is used.</td></tr></tbody></table><p><strong>Note: The &quot;administrator&quot; mentioned in properties does not necessarily refer to the LDAP system administrator. It simply requires the specified LDAP user to have permission to search for entries in the system.</strong></p><h3 id="plug-in-based-custom-identity-and-access-management-implementation" tabindex="-1">Plug-in-based custom identity and access management implementation <a class="header-anchor" href="#plug-in-based-custom-identity-and-access-management-implementation" aria-label="Permalink to &quot;Plug-in-based custom identity and access management implementation&quot;">​</a></h3><p>Authentication plugin interface: <code>im.turms.gateway.infra.plugin.extension.UserAuthenticator</code></p><p>Authorization plug-in interface: TODO</p><p>Readers can refer to <a href="https://turms-im.github.io/docs/server/development/plugin#%E6%8F%92%E4%BB%B6%E5%AE%9E%E7%8E%B0" target="_blank" rel="noreferrer">plugin implementation</a>, implement the above plug-in interface.</p><h2 id="authentication-and-authorization-of-business-logic" tabindex="-1">Authentication and authorization of business logic <a class="header-anchor" href="#authentication-and-authorization-of-business-logic" aria-label="Permalink to &quot;Authentication and authorization of business logic&quot;">​</a></h2><p>For the permission information sent by the client, the attitude of the Turms server is &quot;the permission information sent by the client is not trustworthy&quot;, so the Turms server will do all necessary things according to the business configuration you set on the Turms server. authority judgment.</p><p>Take the &quot;modify sent message&quot; function as an example, this behavior will trigger a series of decision logic. Turms will first judge whether the target message is indeed sent by the user, and then judge whether to allow the user to modify the sent message according to the <code>allowEditMessageBySender</code> configured on the Turms server (default is true), if you set it to false, Then a <code>ResponseException</code> (Kotlin) or <code>ResponseError</code> (JavaScript/Swift) object will be captured on the client side, and it is represented by the business status code model <code>ResponseStatusCode</code> (composed of <code>code</code> and <code>reason</code> description information) .</p><p>For another example, for a &quot;simple&quot; &quot;send message&quot; request, the Turms server will determine whether the user who sent the message is active, whether &quot;allow sending messages to strangers (non-related persons)&quot; is set, and whether the sender of the message is in the blacklist. If the recipient is a group, then it is logically judged whether the sender of the message is a member of the group, and whether it is in a mute state. And you just need to call a <code>sendMessage(...)</code> interface.</p>',12);function b(w,T,v,F,_,A){const i=o("mermaid");return l(),r("div",null,[h,a(i,{dsl:`sequenceDiagram
participant c as Client Application
participant y as Your Server
participant t as turms-gateway
c->>y: ask for JWT token
y-->>c: JWT token
c->>t: login with JWT token as #quot;password#quot;
t->>t: verify token
t-->>c: OK if verified and authenticated`}),c,u,p,m,k,a(i,{dsl:`sequenceDiagram
participant c as Client Application
participant t as turms-gateway
participant y as Your Server
c->>t: login
t->>y: user information
y-->>t: authentication and authorization
t-->>c: OK if authenticated`}),g,y,E,f,a(i,{dsl:`sequenceDiagram
participant c as Client Application
participant t as turms-gateway
participant l as LDAP Server

c->>t: login
t->>l: search user DN by user ID
l-->>t: result entries
alt count is 0
	t-->>c: unauthenticated
else count is more than 1
	t-->>c: internal error
else count is 1
	t->>l: bind by found user DN and password
	l-->>t: result code
	alt result code is 49
		t-->>c: unauthenticated
	else result code is 0
		t-->>c: authenticated
	else
		t-->>c: internal error
	end
end`}),q])}const P=n(d,[["render",b]]);export{D as __pageData,P as default};
