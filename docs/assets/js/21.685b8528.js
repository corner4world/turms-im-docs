(window.webpackJsonp=window.webpackJsonp||[]).push([[21],{374:function(e,t,a){"use strict";a.r(t);var n=a(25),v=Object(n.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"日志"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#日志"}},[e._v("#")]),e._v(" 日志")]),e._v(" "),a("p",[e._v("（以下为设计文档，完整的实现会在X下完成）")]),e._v(" "),a("h2",{attrs:{id:"日志格式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#日志格式"}},[e._v("#")]),e._v(" 日志格式")]),e._v(" "),a("p",[e._v("必须包含四类元信息：\ntime: 日志产生时间，ISO8601格式\nlevel：日志等级， FATAL、ERROR、WARN、INFO、DEBUG\napp_id：应用id，用于标示日志来源，与公司服务树一致，全局唯一\ninstance_id：实例id，用于区分同一应用不同实例，格式业务方自行设定\n日志详细信息统一保存到log字段中。具体原因可查阅：https://softwareengineering.stackexchange.com/questions/312197/benefits-of-structured-logging-vs-basic-logging\n除上述字段之外，业务方也可以自行添加额外的字段。\njson的mapping应保持不变：key不能随意增加、变化，value的类型也应保持不变。")]),e._v(" "),a("p",[e._v('例如：{"log": "hello billions, write more", "level": "INFO", "app_id": "testapp111", "instance_id": "instance1", "time": "2017-08-04T15:59:01.607483", "id": 0}')]),e._v(" "),a("p",[e._v("现在JSON Layout也比较流行，但由于JSON做日志时的最大价值主要是统一不同项目组所负责的服务日志格式，Turms没有采用JSON。是因为：")]),e._v(" "),a("ol",[a("li",[a("p",[e._v("增加不必要的正反序列化耗时")])]),e._v(" "),a("li",[a("p",[e._v("Turms\n总的来说，用了JSON的Overhead时间可能比业务处理本身的时间还长。")]),e._v(" "),a("p",[e._v("没有采用Java中标准的toString实现是因为：？。当然，toString方便后期拓展，这就看团队意愿了。")])])]),e._v(" "),a("p",[e._v("调用链分析")]),e._v(" "),a("p",[e._v("2016-11-11 11:58:38.833  WARN [websocket-service,37e0966f0f3c3a65,37e0966f0f3c3a65,false] 89201 --- [nboundChannel-6] o.s.cloud.sleuth.util.ExceptionUtils     : Tried to detach trace span but it is not the current span: [Trace: 37e0966f0f3c3a65, Span: 37e0966f0f3c3a65, Parent: null, exportable:false]. You may have forgotten to close or detach null")]),e._v(" "),a("p",[e._v("□ appname:service-a/b，是设置的应用名称。\n□ traceId:7feec0479597d1b9, Spring Cloud Sleuth生成的TraceId，一次请求的唯一标识。\n□ spanId:578bef9ed3901d9b, Spring Cloud Sleuth生成的SpanId，标识一个基本的工作单元，此处是Feign进行的HTTP调用。\n□ exportable:false，是否将数据导出，如果只是想要在Span中封装一些操作并将其写日志时，此时就不需要将Span导出。")]),e._v(" "),a("p",[e._v("注意：Turms为保持日志的解析方式简单，异常堆栈的事件也是仅一行（普遍做法是多行，Filebeat也能解析多行日志）。")]),e._v(" "),a("p",[e._v("日志分类")]),e._v(" "),a("ol",[a("li",[a("p",[e._v("监控日志System Log（性能预警等）：API：beginTime, endTime, elapsedTime\n响应时间、调用次数、内存可用率、CPU使用率、网络连通性。")]),e._v(" "),a("p",[e._v("程序运行状况：记录程序的运行状况，特别是非预期的行为、异常情况，这种日志，主要是给开发、维护人员使用。什么时候记录，记录什么内容，完全取决于开发人员，开发者具有高度自主性。本文讨论的主要也是指这种类型的日志，因为作为一个服务端开发、运维人员，程序运行日志往往是解决线上问题的救命稻草。")]),e._v(" "),a("p",[e._v("系统、机器状况：比如网络请求、系统CPU、内存、IO使用情况等等，这种日志主要是给运维人员使用，生成各种更直观的展现形式，在系统出问题的时候报警。")])]),e._v(" "),a("li",[a("p",[e._v("业务日志（用户行为分析.收集用户行为日志https://www.jianshu.com/p/3f8b02aba670）")]),e._v(" "),a("p",[e._v("Audit Log")])]),e._v(" "),a("li",[a("p",[e._v("统计日志。记录用户行为：这种类型的日志，记录用户的操作行为，用于大数据分析，比如监控、风控、推荐等等。这种日志，一般是给其他团队分析使用，而且可能是多个团队，因此一般会有一定的格式要求，开发者应该按照这个格式来记录，便于其他团队的使用。当然，要记录哪些行为、操作，一般也是约定好的，因此，开发者主要是执行的角色。")]),e._v(" "),a("p",[e._v("特别注意的是：用户的行为日志并不是由turms-gateway进行收集的，而是由下游的turms服务端收集的。这么做的原因是：为了达到最为高效的性能，减少不必要的开销，turms-gateway只会从堆外内存中读取少量必要内容来记录用户行为，并不会解析整个用户请求。如果只是为了记录用户行为就将堆外内存全部拷贝到堆内就过于浪费了。")])])]),e._v(" "),a("p",[e._v("日志归档")]),e._v(" "),a("p",[e._v("策略：仅支持本地归档")]),e._v(" "),a("p",[e._v("原计划是要支持三种可选策略：本地归档、MongoDB归档、同时进行本地归档与MongoDB归档。但由于本地归档是大中型项目的最终归宿，并且为了避免部分用户对直接的MongoDB归档产生依赖，导致该类用户后期难以调整。")]),e._v(" "),a("p",[e._v("支持MongoDB归档、支持同时本地归档与MongoDB归档（优先MongoDB归档，如果失败则本地归档）。")]),e._v(" "),a("p",[e._v("注意：MongoDB只是存储跟日志有关的对象模型，实际并不是存储日志")]),e._v(" "),a("p",[e._v("对于本地Turms不提供")]),e._v(" "),a("p",[e._v("如果有其他定制需求，请在XXX处自定义配置")]),e._v(" "),a("p",[e._v("背景")]),e._v(" "),a("p",[e._v("早期Turms架构为了方便快速做基础数据分析功能，直接将用户操作行为与管理员操作行为直接写入MongoDB。这样做有X个缺点，一是实现不灵活，写死了直接日志存储的实现，用户如果想自研接入Kafka或大数据技术栈的话，还需要重构这块代码。二是日志存储实现不统一，因为大部分日志默认只会存储在本地。三是增加了一个网络故障风险，如果需要健全的日志体系，还需要在发现网络故障的时候，将日志存储在本地，实现麻烦。当然优点就是开发者可以快速体验Turms开箱即用的数据分析功能。但对于中大项目而言，数据分析更适合交由大数据技术栈专门实现，否则很难在满足自身定制需求与高效实现中找到平衡。")]),e._v(" "),a("p",[e._v("因此现在Turms的日志存储采用标准的中大项目实现，即Turms只进行本地的日志存储操作，具体的日志采集工作交给开发者自行实现（如采用FileBeat定时进行日志采集，并将数据传给Logtash做解析，解析完后再将数据传给Elasticsearch做存储与分析，最后通过Kibana展示）")]),e._v(" "),a("p",[e._v("https://softwareengineering.stackexchange.com/questions/312197/benefits-of-structured-logging-vs-basic-logging")]),e._v(" "),a("p",[e._v("日志采样")]),e._v(" "),a("p",[e._v("对日志而言，“大量数据中的一小部分就足以进行问题排查和趋势发现”，与研发和运维进行沟通，这个观点也得到认同。日志采样以app_id为维度，INFO级别以下日志按照比例进行随机采样，WARN以上日志全部保留")]),e._v(" "),a("p",[e._v("由于要获取日志内的app_id字段，如果直接进行json解析， cpu消耗将非常之高。后续我们改进为字符查找（bytes.Index ）")]),e._v(" "),a("p",[e._v("日志采集Filebeat, Graylog, Fluentd")]),e._v(" "),a("p",[e._v("日志解析")]),e._v(" "),a("p",[e._v("https://www.elastic.co/guide/en/beats/filebeat/master/multiline-examples.html")])])}),[],!1,null,null,null);t.default=v.exports}}]);