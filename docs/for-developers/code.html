<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.33">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <title>源码 | Turms Documentation</title><meta name="description" content="">
    <link rel="modulepreload" href="/docs/assets/app.4fd9f88d.js"><link rel="modulepreload" href="/docs/assets/code.html.ff0f3e95.js"><link rel="modulepreload" href="/docs/assets/code.html.bc981ed2.js">
    <link rel="stylesheet" href="/docs/assets/style.f74d50ce.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header ref_key="navbar" class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/docs/" class=""><img class="logo" src="https://raw.githubusercontent.com/turms-im/assets/master/logo/pegion.svg" alt="Turms Documentation"><span class="site-name can-hide">Turms Documentation</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a class="external-link" href="https://github.com/turms-im/turms" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" placeholder="搜索" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a class="external-link" href="https://github.com/turms-im/turms" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><a href="/docs/README.md" class="sidebar-item sidebar-heading" aria-label="介绍"><!--[--><!--]--> 介绍 <!--[--><!--]--></a><!----></li><li><p class="sidebar-item sidebar-heading collapsible">业务功能 <span class="right arrow"></span></p><!--[--><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/docs/features/" class="sidebar-item" aria-label="业务功能介绍"><!--[--><!--]--> 业务功能介绍 <!--[--><!--]--></a><!----></li><li><a href="/docs/features/simultaneous-login.html" class="sidebar-item" aria-label="多端登录"><!--[--><!--]--> 多端登录 <!--[--><!--]--></a><!----></li><li><a href="/docs/features/user.html" class="sidebar-item" aria-label="用户相关功能"><!--[--><!--]--> 用户相关功能 <!--[--><!--]--></a><!----></li><li><a href="/docs/features/group.html" class="sidebar-item" aria-label="群组相关功能"><!--[--><!--]--> 群组相关功能 <!--[--><!--]--></a><!----></li><li><a href="/docs/features/message.html" class="sidebar-item" aria-label="消息相关功能"><!--[--><!--]--> 消息相关功能 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><p class="sidebar-item sidebar-heading active collapsible">服务端知识 <span class="down arrow"></span></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><p class="sidebar-item">部署 <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/docs/for-developers/getting-started.html" class="sidebar-item" aria-label="搭建与启动"><!--[--><!--]--> 搭建与启动 <!--[--><!--]--></a><!----></li><li><a href="/docs/for-developers/distribution.html" class="sidebar-item" aria-label="发布"><!--[--><!--]--> 发布 <!--[--><!--]--></a><!----></li><li><a href="/docs/for-developers/config.html" class="sidebar-item" aria-label="配置参数"><!--[--><!--]--> 配置参数 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><p class="sidebar-item">设计 <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/docs/for-developers/architecture.html" class="sidebar-item" aria-label="架构设计"><!--[--><!--]--> 架构设计 <!--[--><!--]--></a><!----></li><li><a href="/docs/for-developers/schema.html" class="sidebar-item" aria-label="集合结构设计"><!--[--><!--]--> 集合结构设计 <!--[--><!--]--></a><!----></li><li><a href="/docs/for-developers/status-aware.html" class="sidebar-item" aria-label="状态感知"><!--[--><!--]--> 状态感知 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><p class="sidebar-item active">开发 <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/docs/for-developers/redevelopment.html" class="sidebar-item" aria-label="关于二次开发"><!--[--><!--]--> 关于二次开发 <!--[--><!--]--></a><!----></li><li><a href="/docs/for-developers/rules.html" class="sidebar-item" aria-label="开发基本规约"><!--[--><!--]--> 开发基本规约 <!--[--><!--]--></a><!----></li><li><a href="/docs/for-developers/plugin.html" class="sidebar-item" aria-label="自定义插件"><!--[--><!--]--> 自定义插件 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/docs/for-developers/code.html" class="router-link-active router-link-exact-active router-link-active sidebar-item active" aria-label="源码"><!--[--><!--]--> 源码 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/docs/for-developers/code.html#客户端请求处理流程" class="router-link-active router-link-exact-active sidebar-item" aria-label="客户端请求处理流程"><!--[--><!--]--> 客户端请求处理流程 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/docs/for-developers/code.html#uml顺序图" class="router-link-active router-link-exact-active sidebar-item" aria-label="UML顺序图"><!--[--><!--]--> UML顺序图 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/docs/for-developers/code.html#turms-gateway" class="router-link-active router-link-exact-active sidebar-item" aria-label="turms-gateway"><!--[--><!--]--> turms-gateway <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/docs/for-developers/code.html#turms-service" class="router-link-active router-link-exact-active sidebar-item" aria-label="turms-service"><!--[--><!--]--> turms-service <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/docs/for-developers/code.html#通知下发" class="router-link-active router-link-exact-active sidebar-item" aria-label="通知下发"><!--[--><!--]--> 通知下发 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/docs/for-developers/code.html#uml顺序图-1" class="router-link-active router-link-exact-active sidebar-item" aria-label="UML顺序图"><!--[--><!--]--> UML顺序图 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/docs/for-developers/code.html#turms-service-1" class="router-link-active router-link-exact-active sidebar-item" aria-label="turms-service"><!--[--><!--]--> turms-service <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/docs/for-developers/code.html#turms-gateway-1" class="router-link-active router-link-exact-active sidebar-item" aria-label="turms-gateway"><!--[--><!--]--> turms-gateway <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/docs/for-developers/code.html#集群实现" class="router-link-active router-link-exact-active sidebar-item" aria-label="集群实现"><!--[--><!--]--> 集群实现 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/docs/for-developers/code.html#服务注册与发现" class="router-link-active router-link-exact-active sidebar-item" aria-label="服务注册与发现"><!--[--><!--]--> 服务注册与发现 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/docs/for-developers/code.html#网络连接服务" class="router-link-active router-link-exact-active sidebar-item" aria-label="网络连接服务"><!--[--><!--]--> 网络连接服务 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/docs/for-developers/code.html#rpc" class="router-link-active router-link-exact-active sidebar-item" aria-label="RPC"><!--[--><!--]--> RPC <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></li><li><p class="sidebar-item">主要模块 <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/docs/for-developers/cluster.html" class="sidebar-item" aria-label="集群的设计与实现"><!--[--><!--]--> 集群的设计与实现 <!--[--><!--]--></a><!----></li><li><a href="/docs/for-developers/system-resource-management.html" class="sidebar-item" aria-label="系统资源管理"><!--[--><!--]--> 系统资源管理 <!--[--><!--]--></a><!----></li><li><a href="/docs/for-developers/observability.html" class="sidebar-item" aria-label="可观测性体系"><!--[--><!--]--> 可观测性体系 <!--[--><!--]--></a><!----></li><li><a href="/docs/for-developers/security.html" class="sidebar-item" aria-label="安全"><!--[--><!--]--> 安全 <!--[--><!--]--></a><!----></li><li><a href="/docs/for-developers/anti-spam.html" class="sidebar-item" aria-label="敏感词过滤"><!--[--><!--]--> 敏感词过滤 <!--[--><!--]--></a><!----></li><li><a href="/docs/for-developers/data-analytics.html" class="sidebar-item" aria-label="数据分析"><!--[--><!--]--> 数据分析 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></li><li><a href="/docs/for-developers/client-api.html" class="sidebar-item sidebar-heading" aria-label="客户端接口"><!--[--><!--]--> 客户端接口 <!--[--><!--]--></a><!----></li><li><a href="/docs/for-developers/turms-admin.html" class="sidebar-item sidebar-heading" aria-label="turms-admin"><!--[--><!--]--> turms-admin <!--[--><!--]--></a><!----></li><li><p class="sidebar-item sidebar-heading collapsible">手册 <span class="right arrow"></span></p><!--[--><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/docs/for-developers/admin-api.html" class="sidebar-item" aria-label="管理员API接口"><!--[--><!--]--> 管理员API接口 <!--[--><!--]--></a><!----></li><li><a href="/docs/for-developers/status-code.html" class="sidebar-item" aria-label="状态码"><!--[--><!--]--> 状态码 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="源码" tabindex="-1"><a class="header-anchor" href="#源码" aria-hidden="true">#</a> 源码</h1><p>本文讲解服务端各主要功能模块的大致源码实现，以帮忙开发者更好地理解相关流程。</p><p>注意事项：</p><ol><li>Turms服务端重度使用<a href="https://projectreactor.io/docs/core/release/reference" target="_blank" rel="noopener noreferrer">reactor-core<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>这一响应式框架，本文默认读者已经熟练掌握响应式编程，如果读者还没掌握响应式编程，则建议先自行学习并掌握<a href="https://projectreactor.io/docs/core/release/reference" target="_blank" rel="noopener noreferrer">reactor-core<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>。</li><li>Turms会不定期优化代码，因此一些函数名或函数实现可能会稍微改变，但其思想是不会变的。</li><li>各模块源码所做的事情通常比下文讲得多得多，但为了方便读者理解，<strong>本文只挑选主要流程进行讲解，并略去了大量细节</strong>。如果读者对其中的细节感兴趣，可以在阅读完本文的相关讲解，并对主要流程有大概的认识后，再去阅读源码，了解其具体实现细节。</li></ol><h2 id="客户端请求处理流程" tabindex="-1"><a class="header-anchor" href="#客户端请求处理流程" aria-hidden="true">#</a> 客户端请求处理流程</h2><p>阅读下文前，建议读者先行阅读<a href="https://turms-im.github.io/docs/for-developers/architecture.html#%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AE%BF%E9%97%AE%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B" target="_blank" rel="noopener noreferrer">客户端访问服务端标准流程<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>，先从架构角度理解其背后的设计思路，这样在读源码的时候就不容易“迷路”。</p><p>请求模型：<code>im.turms.common.model.dto.request.TurmsRequest</code></p><p>响应与通知模型：<code>im.turms.common.model.dto.notification.TurmsNotification</code></p><h3 id="uml顺序图" tabindex="-1"><a class="header-anchor" href="#uml顺序图" aria-hidden="true">#</a> UML顺序图</h3><figure class="mermaid-diagram"></figure><h3 id="turms-gateway" tabindex="-1"><a class="header-anchor" href="#turms-gateway" aria-hidden="true">#</a> turms-gateway</h3><p>简介：用于维护与客户端的网络连接，维护应用层会话，并将大部分的业务请求下发给turms-service服务端。</p><h4 id="网络层配置" tabindex="-1"><a class="header-anchor" href="#网络层配置" aria-hidden="true">#</a> 网络层配置</h4><ol><li><p>启动接收客户端请求的服务端</p><p>TCP服务端：<code>im.turms.gateway.access.tcp.factory.TcpServerFactory#create</code></p><p>WebSocket服务端：<code>im.turms.gateway.access.websocket.factory.WebSocketFactory#create</code></p><p>这两个函数主要做的就是：基于reactor-netty，绑定监听地址、配置EventLoop线程池、（可选）配置SSL、开启相关度量等常规工作。</p></li><li><p>对于纯TCP连接（而非预备的WebSocket连接），给新确立的TCP连接绑上编解码Handlers</p><p>在<code>im.turms.gateway.access.tcp.factory.TcpServerFactory#create</code>函数内，通过下述回调，给新TCP连接绑上对应的<code>TurmsRequest</code>与<code>TurmsNotification</code>的编解码实例。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">.</span><span class="token function">doOnConnection</span><span class="token punctuation">(</span>handlerConfig<span class="token operator">::</span><span class="token function">configureConnection</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>其中，<code>configureConnection</code>函数来自：<code>im.turms.gateway.access.tcp.handler.TcpHandlerConfig</code></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">configureConnection</span><span class="token punctuation">(</span><span class="token class-name">Connection</span> connection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    connection<span class="token punctuation">.</span><span class="token function">addHandlerLast</span><span class="token punctuation">(</span><span class="token string">&quot;varintLengthBasedFrameDecoder&quot;</span><span class="token punctuation">,</span> <span class="token class-name">CodecFactory</span><span class="token punctuation">.</span><span class="token function">getExtendedVarintLengthBasedFrameDecoder</span><span class="token punctuation">(</span>maxFrameLength<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    connection<span class="token punctuation">.</span><span class="token function">addHandlerLast</span><span class="token punctuation">(</span><span class="token string">&quot;varintLengthFieldPrepender&quot;</span><span class="token punctuation">,</span> <span class="token class-name">CodecFactory</span><span class="token punctuation">.</span><span class="token function">getVarintLengthFieldPrepender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    connection<span class="token punctuation">.</span><span class="token function">addHandlerLast</span><span class="token punctuation">(</span><span class="token string">&quot;protobufFrameEncoder&quot;</span><span class="token punctuation">,</span> <span class="token class-name">CodecFactory</span><span class="token punctuation">.</span><span class="token function">getProtobufFrameEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li><li><p>对于WebSocket连接，则先监听并校验HTTP Upgrade请求，然后再Upgrade成WebSocket连接</p><p>在<code>im.turms.gateway.access.websocket.factory.WebSocketFactory#create</code>函数内，通过下述代码绑定HTTP监听回调：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>.handle(getHttpRequestHandler(handler, serverSpec))
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>其中<code>getHttpRequestHandler</code>函数来自<code>im.turms.gateway.access.websocket.factory.WebSocketFactory#getHttpRequestHandler</code>，该回调用于校验HTTP请求，如果监听到是合法的HTTP Upgrade请求，则将该连接升级为WebSocket连接。</p></li></ol><p>至此，纯网络层的操作基本就完成了，下一步就是衔接网络层与业务逻辑层。</p><h4 id="网络层与业务逻辑层的衔接" tabindex="-1"><a class="header-anchor" href="#网络层与业务逻辑层的衔接" aria-hidden="true">#</a> 网络层与业务逻辑层的衔接</h4><ol><li><p>网络层与业务逻辑层，通过函数接口：<code>im.turms.gateway.access.common.function.ConnectionHandler#handle</code>进行绑定，主要绑定的内容就是：输入字节流、输出字节流、连接关闭时的回调函数。</p><p>对于TCP服务端，在<code>im.turms.gateway.access.tcp.factory.TcpServerFactory#create</code>函数下，通过<code>.handle((in, out) -&gt; handler.handle((Connection) in, false, in.receive(), out, ((Connection) in).onDispose()))</code>进行绑定。</p><p>对于WebSocket服务端，在<code>im.turms.gateway.access.websocket.factory.WebSocketFactory#create</code>函数下，通过<code>handler.handle((Connection) in, true, inbound, out, onClose)</code>绑定。</p></li><li><p>上述<code>handler.handle</code>会调用下述的<code>im.turms.gateway.access.common.UserSessionDispatcher#bindConnectionWithSessionWrapper</code>回调函数，用于协调处理输入字节流与输出字节流的逻辑，而从全局视角来看，这些字节数据本质上就是上层业务层的<code>请求</code>、<code>响应</code>与<code>通知</code>，因此这部分代码是服务端与客户端交互的重点，我们之后还会回看这块代码。其源码如下：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">ConnectionHandler</span> <span class="token function">bindConnectionWithSessionWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>connection<span class="token punctuation">,</span> isWebSocketConnection<span class="token punctuation">,</span> in<span class="token punctuation">,</span> out<span class="token punctuation">,</span> onClose<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">InetSocketAddress</span> address <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InetSocketAddress</span><span class="token punctuation">)</span> connection<span class="token punctuation">.</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">NetConnection</span> netConnection <span class="token operator">=</span> <span class="token class-name">NetConnection</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">UserSessionWrapper</span> sessionWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserSessionWrapper</span><span class="token punctuation">(</span>netConnection<span class="token punctuation">,</span> address<span class="token punctuation">,</span> closeIdleConnectionAfterSeconds<span class="token punctuation">,</span>
                userSession <span class="token operator">-&gt;</span> userSession<span class="token punctuation">.</span><span class="token function">setNotificationConsumer</span><span class="token punctuation">(</span><span class="token punctuation">(</span>turmsNotificationBuffer<span class="token punctuation">,</span> tracingContext<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    turmsNotificationBuffer<span class="token punctuation">.</span><span class="token function">touch</span><span class="token punctuation">(</span>turmsNotificationBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">NettyOutbound</span> outbound <span class="token operator">=</span> isWebSocketConnection
                            <span class="token operator">?</span> out<span class="token punctuation">.</span><span class="token function">sendObject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BinaryWebSocketFrame</span><span class="token punctuation">(</span>turmsNotificationBuffer<span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token operator">:</span> out<span class="token punctuation">.</span><span class="token function">sendObject</span><span class="token punctuation">(</span>turmsNotificationBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>outbound<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> t <span class="token operator">-&gt;</span> <span class="token function">handleConnectionError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> netConnection<span class="token punctuation">,</span> userSession<span class="token punctuation">,</span> tracingContext<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">respondToRequests</span><span class="token punctuation">(</span>connection<span class="token punctuation">,</span> isWebSocketConnection<span class="token punctuation">,</span> in<span class="token punctuation">,</span> out<span class="token punctuation">,</span> sessionWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">tryRemoveSessionInfoOnConnectionClosed</span><span class="token punctuation">(</span>onClose<span class="token punctuation">,</span> sessionWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>其中，<code>userSession.setNotificationConsumer</code>用于设置监听<code>通知</code>的回调函数，该回调函数会将接收到的<code>通知</code>字节数据，发送给客户端。这个回调函数也是重点，因为我们之后讲到的turms-service给turms-gateway发送<code>通知</code>的流程，其最终会回到这里。</p><p>而<code>respondToRequests</code>函数则用于监听<code>请求</code>输入字节流，并对返回对应的<code>响应</code>输出字节流，该函数源码如下：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">respondToRequests</span><span class="token punctuation">(</span><span class="token class-name">Connection</span> connection<span class="token punctuation">,</span>
                       <span class="token keyword">boolean</span> isWebSocketConnection<span class="token punctuation">,</span>
                       <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ByteBuf</span><span class="token punctuation">&gt;</span></span> in<span class="token punctuation">,</span>
                       <span class="token class-name">NettyOutbound</span> out<span class="token punctuation">,</span>
                       <span class="token class-name">UserSessionWrapper</span> sessionWrapper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    in
            <span class="token punctuation">.</span><span class="token function">doOnNext</span><span class="token punctuation">(</span>requestData <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>connection<span class="token punctuation">.</span><span class="token function">isDisposed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                requestData<span class="token punctuation">.</span><span class="token function">retain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">TracingContext</span> ctx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TracingContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                clientRequestDispatcher<span class="token punctuation">.</span><span class="token function">handleRequest</span><span class="token punctuation">(</span>sessionWrapper<span class="token punctuation">,</span> requestData<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">onErrorResume</span><span class="token punctuation">(</span>throwable <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                            ctx<span class="token punctuation">.</span><span class="token function">updateThreadContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token function">handleNotificationError</span><span class="token punctuation">(</span>throwable<span class="token punctuation">,</span> sessionWrapper<span class="token punctuation">.</span><span class="token function">getUserSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>turmsNotificationBuffer <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                            <span class="token class-name">NettyOutbound</span> outbound <span class="token operator">=</span> isWebSocketConnection
                                    <span class="token operator">?</span> out<span class="token punctuation">.</span><span class="token function">sendObject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BinaryWebSocketFrame</span><span class="token punctuation">(</span>turmsNotificationBuffer<span class="token punctuation">)</span><span class="token punctuation">)</span>
                                    <span class="token operator">:</span> out<span class="token punctuation">.</span><span class="token function">sendObject</span><span class="token punctuation">(</span>turmsNotificationBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>outbound<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">contextWrite</span><span class="token punctuation">(</span>context <span class="token operator">-&gt;</span> context<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">TracingContext</span><span class="token punctuation">.</span>CTX_KEY_NAME<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">doFinally</span><span class="token punctuation">(</span>signal <span class="token operator">-&gt;</span> ctx<span class="token punctuation">.</span><span class="token function">clearThreadContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> t <span class="token operator">-&gt;</span> <span class="token function">handleConnectionError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> sessionWrapper<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                sessionWrapper<span class="token punctuation">.</span><span class="token function">getUserSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ctx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> t <span class="token operator">-&gt;</span> <span class="token function">handleConnectionError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> sessionWrapper<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    sessionWrapper<span class="token punctuation">.</span><span class="token function">getUserSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TracingContext</span><span class="token punctuation">.</span>NOOP<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>其中，<code>respondToRequests</code>在<code>clientRequestDispatcher.handleRequest(sessionWrapper, requestData)</code>处，将<code>请求</code>的字节流<code>ByteBuf</code>，递交给下游的业务逻辑层进行处理；在<code>.flatMap(turmsNotificationBuffer -&gt; {</code>回调处，将请求的<code>响应</code>字节流进行输出。</p><p>至此，网络层的数据已经传达到了下游业务层，网络层<code>接收请求</code>的工作结束了，接下来就都是业务层相关操作。</p><p>注意：虽然网络层<code>接收请求</code>的工作结束了，但网络层之后还要处理下游业务逻辑层发回的<code>响应</code>与<code>通知</code>字节数据，而这收尾的代码，上文已经提及，就不赘述了。</p></li></ol><h4 id="业务层——请求调度层" tabindex="-1"><a class="header-anchor" href="#业务层——请求调度层" aria-hidden="true">#</a> 业务层——请求调度层</h4><p>经由网络层的操作，来到了<code>im.turms.gateway.access.common.ClientRequestDispatcher#handleRequest</code>。该函数完成：调度心跳请求、业务请求；简单校验请求，如果是非法请求，则尝试拉黑等。</p><p>该函数的代码虽多，但其实很容易读，我们这里主要关注的是<code>handleServiceRequest(sessionWrapper, request, serviceRequestBuffer, tracingContext)</code>这行代码，<code>handleServiceRequest</code>函数的主要源码如下：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">return</span> <span class="token keyword">switch</span> <span class="token punctuation">(</span>requestType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> CREATE_SESSION_REQUEST <span class="token operator">-&gt;</span> sessionController
            <span class="token punctuation">.</span><span class="token function">handleCreateSessionRequest</span><span class="token punctuation">(</span>sessionWrapper<span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">createSessionRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>result <span class="token operator">-&gt;</span> <span class="token function">getNotificationFromHandlerResult</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">requestId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> DELETE_SESSION_REQUEST <span class="token operator">-&gt;</span> sessionController<span class="token punctuation">.</span><span class="token function">handleDeleteSessionRequest</span><span class="token punctuation">(</span>sessionWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        serviceRequestBuffer<span class="token punctuation">.</span><span class="token function">retain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">yield</span> <span class="token function">handleServiceRequestForTurms</span><span class="token punctuation">(</span>sessionWrapper<span class="token punctuation">,</span> request<span class="token punctuation">,</span> serviceRequestBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ul><li><p>将<code>CREATE_SESSION_REQUEST</code>与<code>DELETE_SESSION_REQUEST</code>这两个turms-gateway能自行处理的请求交由自己的Controller层进行处理，即<code>im.turms.gateway.access.common.controller.SessionController</code>，该Controller主要就是借由<code>im.turms.gateway.service.impl.session.SessionService</code>服务与Redis服务端进行交互，执行用户<code>登陆</code>与<code>登出</code>相关逻辑。由于业务逻辑并非本篇的重点，这里就不展开讲了。等这Controller与Service的逻辑都处理完，则返回一个<code>TurmsNotification</code>对象，并经由上述的网络层与编解码Handlers，最终将字节数据发送给客户端。</p></li><li><p>对于其他所有请求，turms-gateway通过上述的<code>handleServiceRequestForTurms</code>函数，最终经由RPC，将客户端请求下发给turms-service进行处理。其中的大致调用流程如下：经过几层简单的调用，来到<code>im.turms.gateway.service.impl.message.InboundRequestService#processServiceRequest0</code>，该函数会调用<code>im.turms.gateway.service.impl.message.InboundRequestService#sendServiceRequest</code>通过自研RPC框架，将包装有客户端请求字节数据的RPC请求<code>im.turms.server.common.rpc.request.HandleServiceRequest</code>下发给turms-service进行处理。其中，具体RPC的实现并非本篇重点，这里就不展开讲了。等turms-service处理完请求，会返回一个<code>im.turms.server.common.dto.ServiceResponse</code>，该对象会在上述的<code>im.turms.gateway.service.impl.message.InboundRequestService#processServiceRequest0</code>函数的代码，经过下述的<code>getNotificationFromResponse</code>函数将<code>ServiceResponse</code>转换为<code>TurmsNotification</code>，并经由上述的网络层与编解码Handlers，最终将字节数据发送给客户端。：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">return</span> <span class="token function">sendServiceRequest</span><span class="token punctuation">(</span>serviceRequest<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">defaultIfEmpty</span><span class="token punctuation">(</span>REQUEST_RESPONSE_NO_CONTENT<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>response <span class="token operator">-&gt;</span> <span class="token function">getNotificationFromResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> serviceRequest<span class="token punctuation">.</span><span class="token function">getRequestId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li></ul><p>至此，turms-gateway的客户端请求的处理逻辑就讲解完了，下文接着讲解turms-service是如何处理上游turms-gateway发来的RPC请求的。</p><h3 id="turms-service" tabindex="-1"><a class="header-anchor" href="#turms-service" aria-hidden="true">#</a> turms-service</h3><p>（RPC实现属于“集群服务”实现内容，这里不做相关讲解）</p><ol><li><p>请求调度层</p><p>经由RPC层的处理，turms-service会首先通过<code>im.turms.service.workflow.access.servicerequest.dispatcher.ServiceRequestDispatcher#dispatch</code>拿到客户端请求的字节数据。该函数会调用<code>im.turms.service.workflow.access.servicerequest.dispatcher.ServiceRequestDispatcher#dispatch0</code>函数，完成诸如：请求校验、客户端拉黑、判断服务端监控状态、触发插件与调用Controller层接口函数、触发上游等任务。代码虽多，但其实还是比较易读的，这里我们主要看到其中的<code>result = handler.handle(lastClientRequest);</code>这行代码，<code>handler#handle</code>函数其实是<code>im.turms.service.workflow.access.servicerequest.dispatcher.ClientRequestHandler#handle</code>函数，而<code>handle</code>函数的实现，其实就是各Controller层接口的实现。</p></li><li><p>请求Controller层</p><p>各Controller通过上述的<code>handle</code>函数，拿到了传来的<code>im.turms.service.workflow.access.servicerequest.dto.ClientRequest</code>对象后，就开始执行相关的业务逻辑，并向MongoDB服务端发送各种CRUD请求。业务逻辑处理并非本篇重点，这里就不展开讲解了。等Controller层处理完相关业务逻辑，就会返回一个<code>im.turms.service.workflow.access.servicerequest.dto.RequestHandlerResult</code>对象。简单来说，该对象描述了：要发回给客户端的<code>响应</code>，与要发给其他用户的<code>通知</code>（如发送群聊消息，对于消息的接收客户端，这些发送给它们的输出字节流就是<code>通知</code>）。</p><p>对于<code>响应</code>，会借由上述的RPC操作，将字节数据发回给turms-gateway，而turms-gateway再通过上述已经提及过的<code>respondToRequests</code>函数里的<code>.flatMap(turmsNotificationBuffer -&gt; {</code>，最终将响应字节数据发送给客户端。</p></li></ol><p>至此，一个请求就被处理完了。</p><h2 id="通知下发" tabindex="-1"><a class="header-anchor" href="#通知下发" aria-hidden="true">#</a> 通知下发</h2><p>通知模型：<code>im.turms.common.model.dto.notification.TurmsNotification</code></p><p><code>通知</code>有且仅会被turms-service生成，turms-gateway不会自行生成<code>通知</code>。</p><h3 id="uml顺序图-1" tabindex="-1"><a class="header-anchor" href="#uml顺序图-1" aria-hidden="true">#</a> UML顺序图</h3><figure class="mermaid-diagram"></figure><h3 id="turms-service-1" tabindex="-1"><a class="header-anchor" href="#turms-service-1" aria-hidden="true">#</a> turms-service</h3><p>在上文中，我们讲到turms-service在处理完客户端请求的业务逻辑后，会返回一个<code>im.turms.service.workflow.access.servicerequest.dto.RequestHandlerResult</code>对象，该对象也包含了：通知数据与一组需要接收通知的用户ID。该对象会被先传递到<code>im.turms.service.workflow.access.servicerequest.dispatcher.ServiceRequestDispatcher#dispatch0</code>函数里的下述回调中：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">.</span><span class="token function">doOnEach</span><span class="token punctuation">(</span>signal <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>signal<span class="token punctuation">.</span><span class="token function">isOnNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">RequestHandlerResult</span> requestResult <span class="token operator">=</span> signal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>requestResult <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> requestResult<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">TurmsStatusCode</span><span class="token punctuation">.</span>OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">notifyRelatedUsersOfAction</span><span class="token punctuation">(</span>requestResult<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> deviceType<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">contextWrite</span><span class="token punctuation">(</span>signal<span class="token punctuation">.</span><span class="token function">getContextView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> t <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">TracingCloseableContext</span> ignored <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">asCloseable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    LOGGER<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to notify related users of the action&quot;</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>其中，<code>notifyRelatedUsersOfAction</code>函数会异步发送<code>通知</code>给相关用户，其代码实现如下：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">notifyRelatedUsersOfAction</span><span class="token punctuation">(</span>
        <span class="token class-name">RequestHandlerResult</span> result<span class="token punctuation">,</span>
        <span class="token class-name">Long</span> requesterId<span class="token punctuation">,</span>
        <span class="token class-name">DeviceType</span> requesterDevice<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">TurmsRequest</span> dataForRecipients <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">dataForRecipients</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> recipients <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">recipients</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dataForRecipients <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> recipients<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">TurmsNotification</span> notificationForRecipients <span class="token operator">=</span> <span class="token class-name">TurmsNotification</span>
            <span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setRelayedRequest</span><span class="token punctuation">(</span>dataForRecipients<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setRequesterId</span><span class="token punctuation">(</span>requesterId<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ByteBuf</span> notificationByteBuf <span class="token operator">=</span> <span class="token class-name">ProtoUtil</span><span class="token punctuation">.</span><span class="token function">getDirectByteBuffer</span><span class="token punctuation">(</span>notificationForRecipients<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">forwardDataForRecipientsToOtherSenderOnlineDevices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        notificationByteBuf<span class="token punctuation">.</span><span class="token function">retain</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> notifyRequesterMono <span class="token operator">=</span> outboundMessageService
                <span class="token punctuation">.</span><span class="token function">forwardNotification</span><span class="token punctuation">(</span>notificationForRecipients<span class="token punctuation">,</span> notificationByteBuf<span class="token punctuation">,</span> requesterId<span class="token punctuation">,</span> requesterDevice<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> notifyRecipientsMono <span class="token operator">=</span> outboundMessageService
                <span class="token punctuation">.</span><span class="token function">forwardNotification</span><span class="token punctuation">(</span>notificationForRecipients<span class="token punctuation">,</span> notificationByteBuf<span class="token punctuation">,</span> recipients<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span>notifyRequesterMono<span class="token punctuation">,</span> notifyRecipientsMono<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">doFinally</span><span class="token punctuation">(</span>signal <span class="token operator">-&gt;</span> notificationByteBuf<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> outboundMessageService<span class="token punctuation">.</span><span class="token function">forwardNotification</span><span class="token punctuation">(</span>notificationForRecipients<span class="token punctuation">,</span> notificationByteBuf<span class="token punctuation">,</span> recipients<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>我们主要看<code>outboundMessageService.forwardNotification</code>函数，该函数首先会通过<code>im.turms.server.common.service.session.UserStatusService#getDeviceAndNodeIdMapByUserId</code>函数从本地缓存或者Redis服务端中拉取通知接收用户ID所在的turms-gateway服务端节点ID，拿到这些节点ID后，再通过<code>im.turms.service.workflow.service.impl.message.OutboundMessageService#forwardClientMessageToNodes</code>函数，将<code>通知</code>通过RPC实现，转发给这些节点，让其进行具体的通知下发操作。具体代码实现如下：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">forwardNotification</span><span class="token punctuation">(</span>
        <span class="token class-name">TurmsNotification</span> notificationForLogging<span class="token punctuation">,</span>
        <span class="token class-name">ByteBuf</span> notificationData<span class="token punctuation">,</span>
        <span class="token class-name">Long</span> recipientId<span class="token punctuation">,</span>
        <span class="token class-name">DeviceType</span> excludedDeviceType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> userStatusService<span class="token punctuation">.</span><span class="token function">getDeviceAndNodeIdMapByUserId</span><span class="token punctuation">(</span>recipientId<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">doOnError</span><span class="token punctuation">(</span>t <span class="token operator">-&gt;</span> notificationData<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>deviceTypeAndNodeIdMap <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> nodeIds <span class="token operator">=</span> <span class="token class-name">CollectionUtil</span><span class="token punctuation">.</span><span class="token function">newSetWithExpectedSize</span><span class="token punctuation">(</span>deviceTypeAndNodeIdMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DeviceType</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> deviceTypeAndNodeIdMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">DeviceType</span> deviceType <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>deviceType <span class="token operator">!=</span> excludedDeviceType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        nodeIds<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>nodeIds<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    notificationData<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> mono <span class="token operator">=</span> <span class="token function">forwardClientMessageToNodes</span><span class="token punctuation">(</span>notificationData<span class="token punctuation">,</span> nodeIds<span class="token punctuation">,</span> recipientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">tryLogNotification</span><span class="token punctuation">(</span>mono<span class="token punctuation">,</span> notificationForLogging<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">switchIfEmpty</span><span class="token punctuation">(</span><span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">fromCallable</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                notificationData<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h3 id="turms-gateway-1" tabindex="-1"><a class="header-anchor" href="#turms-gateway-1" aria-hidden="true">#</a> turms-gateway</h3><p><code>通知</code>经过RPC的转发后，turms-gateway首先会在<code>im.turms.gateway.service.impl.message.OutboundMessageService#sendNotificationToLocalClients</code>函数中获得turms-service发来的<code>通知</code>字节数据。该函数会调用<code>userSession.sendNotification(wrappedNotificationData, tracingContext)</code>将通知数据发送给该批用户的会话。而<code>sendNotification</code>函数就是之前我们让读者重点注意的，在<code>im.turms.gateway.access.common.UserSessionDispatcher#bindConnectionWithSessionWrapper</code>的回调函数，该函数通过<code>out.sendObject</code>完成通知的字节数据下发。具体代码如下：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">UserSessionWrapper</span> sessionWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserSessionWrapper</span><span class="token punctuation">(</span>netConnection<span class="token punctuation">,</span> address<span class="token punctuation">,</span> closeIdleConnectionAfterSeconds<span class="token punctuation">,</span>
        userSession <span class="token operator">-&gt;</span> userSession<span class="token punctuation">.</span><span class="token function">setNotificationConsumer</span><span class="token punctuation">(</span><span class="token punctuation">(</span>turmsNotificationBuffer<span class="token punctuation">,</span> tracingContext<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            turmsNotificationBuffer<span class="token punctuation">.</span><span class="token function">touch</span><span class="token punctuation">(</span>turmsNotificationBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">NettyOutbound</span> outbound <span class="token operator">=</span> isWebSocketConnection
                    <span class="token operator">?</span> out<span class="token punctuation">.</span><span class="token function">sendObject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BinaryWebSocketFrame</span><span class="token punctuation">(</span>turmsNotificationBuffer<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token operator">:</span> out<span class="token punctuation">.</span><span class="token function">sendObject</span><span class="token punctuation">(</span>turmsNotificationBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>outbound<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> t <span class="token operator">-&gt;</span> <span class="token function">handleConnectionError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> netConnection<span class="token punctuation">,</span> userSession<span class="token punctuation">,</span> tracingContext<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>至此，<code>通知</code>发送完毕。</p><h2 id="集群实现" tabindex="-1"><a class="header-anchor" href="#集群实现" aria-hidden="true">#</a> 集群实现</h2><p>在阅读下述源码前，建议读者先阅读<a href="https://turms-im.github.io/docs/for-developers/cluster.html" target="_blank" rel="noopener noreferrer">集群的设计与实现<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>，理解集群服务的基本设计与职责。</p><h3 id="服务注册与发现" tabindex="-1"><a class="header-anchor" href="#服务注册与发现" aria-hidden="true">#</a> 服务注册与发现</h3><p>TODO</p><h3 id="网络连接服务" tabindex="-1"><a class="header-anchor" href="#网络连接服务" aria-hidden="true">#</a> 网络连接服务</h3><p>TODO</p><h3 id="rpc" tabindex="-1"><a class="header-anchor" href="#rpc" aria-hidden="true">#</a> RPC</h3><p>本文将继续以在上文<code>客户端请求处理流程</code>提到的RPC请求示例进行讲解，即：turms-gateway向turms-service发送<code>HandleServiceRequest</code>这一RPC请求。</p><h4 id="handleservicerequest的rpc发送端" tabindex="-1"><a class="header-anchor" href="#handleservicerequest的rpc发送端" aria-hidden="true">#</a> HandleServiceRequest的RPC发送端</h4><h5 id="uml顺序图-2" tabindex="-1"><a class="header-anchor" href="#uml顺序图-2" aria-hidden="true">#</a> UML顺序图</h5><figure class="mermaid-diagram"></figure><h5 id="业务层" tabindex="-1"><a class="header-anchor" href="#业务层" aria-hidden="true">#</a> 业务层</h5><p>接着上文，turms-gateway会通过<code>im.turms.gateway.service.impl.message.InboundRequestService#sendServiceRequest</code>函数向turms-service发送<code>HandleServiceRequest</code>，而该函数会调用RPC服务的<code>im.turms.server.common.cluster.service.rpc.RpcService#requestResponse</code>函数，将RPC请求的处理逻辑代理给下游RPC服务执行，具体代码如下：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceResponse</span><span class="token punctuation">&gt;</span></span> <span class="token function">sendServiceRequest</span><span class="token punctuation">(</span><span class="token class-name">ServiceRequest</span> serviceRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">HandleServiceRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HandleServiceRequest</span><span class="token punctuation">(</span>serviceRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> node<span class="token punctuation">.</span><span class="token function">getRpcService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">requestResponse</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h5 id="rpc层——逻辑层" tabindex="-1"><a class="header-anchor" href="#rpc层——逻辑层" aria-hidden="true">#</a> RPC层——逻辑层</h5><p>由于函数调用方并没有指定<code>HandleServiceRequest</code>请求的RPC接收节点，因此<code>requestResponse</code>函数会首先通过<code>im.turms.server.common.cluster.service.rpc.RpcService#getOtherActiveConnectedMembersToRespond</code>函数，获得一批可以处理该RPC请求的节点，在判断完这些节点的健康状态后，如果不存在健康的节点，则抛异常，否则再将这RPC请求通过<code>im.turms.server.common.cluster.service.codec.CodecService#serializeWithoutCodecId</code>编码成字节数据，并通过<code>endpoint.sendRequest(request, requestBody)</code>这一函数，将字节数据交由下游的网络层进行发送。<code>requestResponse0</code>的具体源码如下：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">requestResponse0</span><span class="token punctuation">(</span><span class="token class-name">RpcEndpoint</span> endpoint<span class="token punctuation">,</span>
                             <span class="token class-name">RpcRequest</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> request<span class="token punctuation">,</span>
                             <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Duration</span> timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token function">assertCurrentNodeIsAllowedToSend</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        request<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        timeout <span class="token operator">=</span> defaultRequestTimeoutDuration<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> mono <span class="token operator">=</span> <span class="token class-name">Mono</span>
            <span class="token punctuation">.</span><span class="token function">deferContextual</span><span class="token punctuation">(</span>context <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token function">addTraceIdToRequestFromContext</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">ByteBuf</span> requestBody<span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    requestBody <span class="token operator">=</span> codecService<span class="token punctuation">.</span><span class="token function">serializeWithoutCodecId</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    request<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>&quot;<span class="token class-name">Failed</span> <span class="token keyword">to</span> <span class="token namespace">encode</span> the
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> endpoint<span class="token punctuation">.</span><span class="token function">sendRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> requestBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span>METRICS_NAME_RPC_REQUEST<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">tag</span><span class="token punctuation">(</span>METRICS_TAG_REQUEST_NAME<span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">tag</span><span class="token punctuation">(</span>METRICS_TAG_REQUEST_TARGET_NODE_ID<span class="token punctuation">,</span> endpoint<span class="token punctuation">.</span><span class="token function">getNodeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Tag</span> tag <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">tag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mono <span class="token operator">=</span> mono<span class="token punctuation">.</span><span class="token function">tag</span><span class="token punctuation">(</span>tag<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tag<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> mono
            <span class="token punctuation">.</span><span class="token function">metrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">onErrorMap</span><span class="token punctuation">(</span>t <span class="token operator">-&gt;</span> <span class="token function">mapThrowable</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><h5 id="rpc层——网络层" tabindex="-1"><a class="header-anchor" href="#rpc层——网络层" aria-hidden="true">#</a> RPC层——网络层</h5><p>RPC请求在被上游RPC逻辑层编码成字节数据后，会被传递给<code>im.turms.server.common.cluster.service.rpc.RpcEndpoint#sendRequest</code>函数，该函数会通过<code>RpcFrameEncoder.INSTANCE.encodeRequest(request, requestBody)</code>再给该字节数据append上<code>请求类型ID</code>与<code>请求ID</code>这两个字节数据，以让RPC对端能够根据<code>请求类型ID</code>进行解码，并通过<code>请求ID</code>返回对应的响应，并最终发送字节流数据给RPC对端。<code>sendRequest</code>具体代码实现如下：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">sendRequest</span><span class="token punctuation">(</span><span class="token class-name">RpcRequest</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> request<span class="token punctuation">,</span> <span class="token class-name">ByteBuf</span> requestBody<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ChannelOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> conn <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>requestBody<span class="token punctuation">.</span><span class="token function">refCnt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IllegalReferenceCountException</span><span class="token punctuation">(</span><span class="token string">&quot;The request body has been released&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>conn<span class="token punctuation">.</span><span class="token function">isDisposed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        requestBody<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClosedChannelException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Sinks<span class="token punctuation">.</span>One</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> sink <span class="token operator">=</span> <span class="token class-name">Sinks</span><span class="token punctuation">.</span><span class="token function">one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> requestId <span class="token operator">=</span> <span class="token function">generateRandomId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Sinks<span class="token punctuation">.</span>One</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> previous <span class="token operator">=</span> pendingRequestMap<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>requestId<span class="token punctuation">,</span> sink<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>previous <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        request<span class="token punctuation">.</span><span class="token function">setRequestId</span><span class="token punctuation">(</span>requestId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ByteBuf</span> buffer<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            buffer <span class="token operator">=</span> <span class="token class-name">RpcFrameEncoder</span><span class="token punctuation">.</span>INSTANCE<span class="token punctuation">.</span><span class="token function">encodeRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> requestBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            requestBody<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolveRequest</span><span class="token punctuation">(</span>requestId<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to encode request&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        conn<span class="token punctuation">.</span><span class="token function">sendObject</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> t <span class="token operator">-&gt;</span> <span class="token function">resolveRequest</span><span class="token punctuation">(</span>requestId<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> sink<span class="token punctuation">.</span><span class="token function">asMono</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>至此，RPC发送端的处理流程就结束了。</p><p>特别一提的是：之所以<code>请求ID</code>没有在上游就被编码，这是因为部分RPC请求有可能被发送给多个RPC接收端，如群消息就经常被转发给多个turms-gateway服务端，而通过分别编码，就可以让上游传来的字节数据被共享，无需内存拷贝，极大地提升内存使用率，这也是为什么Turms要自研RPC服务的原因之一。</p><h5 id="handleservicerequest的rpc接收端" tabindex="-1"><a class="header-anchor" href="#handleservicerequest的rpc接收端" aria-hidden="true">#</a> HandleServiceRequest的RPC接收端</h5><p>TODO</p><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="external-link meta-item-label" href="https://github.com/turms-im/turms/edit/main/for-developers/code.md" rel="noopener noreferrer" target="_blank" aria-label="Edit this page"><!--[--><!--]--> Edit this page <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">上次更新: </span><!----></div><!----></footer><nav class="page-nav"><p class="inner"><span class="prev"><a href="/docs/for-developers/plugin.html" class="" aria-label="自定义插件"><!--[--><!--]--> 自定义插件 <!--[--><!--]--></a></span><!----></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/docs/assets/app.4fd9f88d.js" defer></script>
  </body>
</html>
