<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Source Code | Turms Documentation</title>
    <meta name="description" content="A VitePress site">
    <link rel="preload stylesheet" href="/docs/assets/style.cbe3a868.css" as="style">
    <script type="module" src="/docs/assets/app.68b164e3.js"></script>
    <link rel="preload" href="/docs/assets/inter-roman-latin.2ed14f66.woff2" as="font" type="font/woff2" crossorigin="">
  <link rel="modulepreload" href="/docs/assets/chunks/framework.b6850781.js">
  <link rel="modulepreload" href="/docs/assets/chunks/theme.c876e8ff.js">
  <link rel="modulepreload" href="/docs/assets/chunks/mermaid.core.3e3eefb1.js">
  <link rel="modulepreload" href="/docs/assets/server_development_code.md.07c8719f.lean.js">
  <script id="check-dark-light">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-b2cf3e0b><!--[--><!--]--><!--[--><span tabindex="-1" data-v-c8616af1></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-c8616af1> Skip to content </a><!--]--><!----><header class="VPNav" data-v-b2cf3e0b data-v-7e5bc4a5><div class="VPNavBar has-sidebar" data-v-7e5bc4a5 data-v-94c81dcc><div class="container" data-v-94c81dcc><div class="title" data-v-94c81dcc><div class="VPNavBarTitle has-sidebar" data-v-94c81dcc data-v-f4ef19a3><a class="title" href="/docs/" data-v-f4ef19a3><!--[--><!--]--><!--[--><img class="VPImage logo" src="https://raw.githubusercontent.com/turms-im/assets/master/logo/pegion.svg" alt data-v-6db2186b><!--]--><!--[-->Turms Documentation<!--]--><!--[--><!--]--></a></div></div><div class="content" data-v-94c81dcc><div class="curtain" data-v-94c81dcc></div><div class="content-body" data-v-94c81dcc><!--[--><!--]--><div class="VPNavBarSearch search" style="--vp-meta-key:&#39;Meta&#39;;" data-v-94c81dcc><!--[--><div id="docsearch"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg class="DocSearch-Search-Icon" width="20" height="20" viewBox="0 0 20 20" aria-label="search icon"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div><!----><div class="VPFlyout VPNavBarTranslations translations" data-v-94c81dcc data-v-74abcbb9 data-v-764effdf><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="Change language" data-v-764effdf><span class="text" data-v-764effdf><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="option-icon" data-v-764effdf><path d="M0 0h24v24H0z" fill="none"></path><path d=" M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z " class="css-c4d79v"></path></svg>  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-764effdf><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-764effdf><div class="VPMenu" data-v-764effdf data-v-e7ea1737><!----><!--[--><!--[--><div class="items" data-v-74abcbb9><p class="title" data-v-74abcbb9>English</p><!--[--><div class="VPMenuLink" data-v-74abcbb9 data-v-d2c93bab><a class="VPLink link" href="/docs/zh-CN/server/development/code.html" data-v-d2c93bab data-v-8f4dc553><!--[-->简体中文<!--]--><!----></a></div><!--]--></div><!--]--><!--]--></div></div></div><div class="VPNavBarAppearance appearance" data-v-94c81dcc data-v-f6a63727><label title="toggle dark mode" data-v-f6a63727 data-v-a9c8afb8><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-checked="false" data-v-a9c8afb8 data-v-f3c41672><span class="check" data-v-f3c41672><span class="icon" data-v-f3c41672><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-a9c8afb8><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-a9c8afb8><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></label></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-94c81dcc data-v-0394ad82 data-v-f6988cfb><!--[--><a class="VPSocialLink" href="https://github.com/turms-im/turms" aria-label="github" target="_blank" rel="noopener" data-v-f6988cfb data-v-c530cc0a><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-94c81dcc data-v-40855f84 data-v-764effdf><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-764effdf><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-764effdf><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-764effdf><div class="VPMenu" data-v-764effdf data-v-e7ea1737><!----><!--[--><!--[--><div class="group translations" data-v-40855f84><p class="trans-title" data-v-40855f84>English</p><!--[--><div class="VPMenuLink" data-v-40855f84 data-v-d2c93bab><a class="VPLink link" href="/docs/zh-CN/server/development/code.html" data-v-d2c93bab data-v-8f4dc553><!--[-->简体中文<!--]--><!----></a></div><!--]--></div><div class="group" data-v-40855f84><div class="item appearance" data-v-40855f84><p class="label" data-v-40855f84>Appearance</p><div class="appearance-action" data-v-40855f84><label title="toggle dark mode" data-v-40855f84 data-v-a9c8afb8><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-checked="false" data-v-a9c8afb8 data-v-f3c41672><span class="check" data-v-f3c41672><span class="icon" data-v-f3c41672><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-a9c8afb8><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-a9c8afb8><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></label></div></div></div><div class="group" data-v-40855f84><div class="item social-links" data-v-40855f84><div class="VPSocialLinks social-links-list" data-v-40855f84 data-v-f6988cfb><!--[--><a class="VPSocialLink" href="https://github.com/turms-im/turms" aria-label="github" target="_blank" rel="noopener" data-v-f6988cfb data-v-c530cc0a><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-94c81dcc data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><!----></header><div class="VPLocalNav" data-v-b2cf3e0b data-v-f5a2ca58><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-f5a2ca58><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-f5a2ca58><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-f5a2ca58>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-f5a2ca58 data-v-079b16a8><button data-v-079b16a8>Return to top</button><!----></div></div><aside class="VPSidebar" data-v-b2cf3e0b data-v-af16598e><div class="curtain" data-v-af16598e></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-af16598e><span class="visually-hidden" id="sidebar-aria-label" data-v-af16598e> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-af16598e><section class="VPSidebarItem level-0" data-v-af16598e data-v-c4656e6d><!----><div class="items" data-v-c4656e6d><!--[--><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/docs/index.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>Introduction</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/docs/community/index.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>Community FAQ</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-af16598e><section class="VPSidebarItem level-0 collapsible collapsed" data-v-af16598e data-v-c4656e6d><div class="item" role="button" tabindex="0" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><h2 class="text" data-v-c4656e6d>Business Features</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-c4656e6d><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-c4656e6d><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-c4656e6d><!--[--><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/docs/feature/index.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>Business Features</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/docs/feature/simultaneous-login.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>Simultaneous Login</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/docs/feature/user.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>User-related Features</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/docs/feature/group.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>Group-related Features</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/docs/feature/message.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>Message-related Features</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-af16598e><section class="VPSidebarItem level-0 collapsible collapsed" data-v-af16598e data-v-c4656e6d><div class="item" role="button" tabindex="0" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><h2 class="text" data-v-c4656e6d>Design</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-c4656e6d><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-c4656e6d><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-c4656e6d><!--[--><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/docs/design/architecture.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>Architecture Design</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/docs/design/schema.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>Collection Schema Design</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/docs/design/status-aware.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>Status Awareness</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-af16598e><section class="VPSidebarItem level-0 collapsible has-active" data-v-af16598e data-v-c4656e6d><div class="item" role="button" tabindex="0" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><h2 class="text" data-v-c4656e6d>Server Guide</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-c4656e6d><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-c4656e6d><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-c4656e6d><!--[--><section class="VPSidebarItem level-1" data-v-c4656e6d data-v-c4656e6d><div class="item" role="button" tabindex="0" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><h3 class="text" data-v-c4656e6d>Deployment</h3><!----></div><div class="items" data-v-c4656e6d><!--[--><div class="VPSidebarItem level-2 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/docs/server/deployment/getting-started.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>Build and Start</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/docs/server/deployment/distribution.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>Distribution</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/docs/server/deployment/config.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>Configuration</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section><section class="VPSidebarItem level-1 has-active" data-v-c4656e6d data-v-c4656e6d><div class="item" role="button" tabindex="0" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><h3 class="text" data-v-c4656e6d>Development</h3><!----></div><div class="items" data-v-c4656e6d><!--[--><div class="VPSidebarItem level-2 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/docs/server/development/redevelopment.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>About Secondary Development</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/docs/server/development/rules.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>Basic Development Rules</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/docs/server/development/plugin.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>Custom Plugins</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link is-active has-active" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/docs/server/development/code.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>Source Code</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/docs/server/development/testing.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>Testing</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section><section class="VPSidebarItem level-1" data-v-c4656e6d data-v-c4656e6d><div class="item" role="button" tabindex="0" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><h3 class="text" data-v-c4656e6d>Main Modules</h3><!----></div><div class="items" data-v-c4656e6d><!--[--><div class="VPSidebarItem level-2 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/docs/server/module/identity-access-management.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>Identity and Access Management</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/docs/server/module/cluster.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>Cluster Design and Implementation</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/docs/server/module/system-resource-management.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>System Resource Management</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/docs/server/module/observability.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>Observability</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/docs/server/module/security.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>Security</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/docs/server/module/storage.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>Storage Service</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/docs/server/module/chatbot.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>Chatbot</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/docs/server/module/anti-spam.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>Content Moderation</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/docs/server/module/data-analytics.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>Data Analysis</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section><!--]--></div></section></div><div class="group" data-v-af16598e><section class="VPSidebarItem level-0 collapsible collapsed" data-v-af16598e data-v-c4656e6d><div class="item" role="button" tabindex="0" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><h2 class="text" data-v-c4656e6d>Client Guide</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-c4656e6d><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-c4656e6d><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-c4656e6d><!--[--><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/docs/client/quick-start.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>Quick Start</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/docs/client/requirements.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>Version Requirements</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/docs/client/api.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>API</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/docs/client/session.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>Session Lifecycle</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/docs/client/metrics.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>Metrics</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/docs/client/communication-protocol.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>Communication Protocol Used Between Client and Server</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/docs/client/turms-client-js.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>turms-client-js Shared Context</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-af16598e><section class="VPSidebarItem level-0" data-v-af16598e data-v-c4656e6d><!----><div class="items" data-v-c4656e6d><!--[--><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/docs/turms-admin.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>turms-admin</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-af16598e><section class="VPSidebarItem level-0 collapsible collapsed" data-v-af16598e data-v-c4656e6d><div class="item" role="button" tabindex="0" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><h2 class="text" data-v-c4656e6d>Reference</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-c4656e6d><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-c4656e6d><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-c4656e6d><!--[--><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/docs/reference/admin-api.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>Admin API</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-c4656e6d data-v-c4656e6d><div class="item" data-v-c4656e6d><div class="indicator" data-v-c4656e6d></div><a class="VPLink link link" href="/docs/reference/status-code.html" data-v-c4656e6d data-v-8f4dc553><!--[--><p class="text" data-v-c4656e6d>Status Code</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-b2cf3e0b data-v-a494bd1d><div class="VPDoc has-sidebar has-aside" data-v-a494bd1d data-v-c4b0d3cf><!--[--><!--]--><div class="container" data-v-c4b0d3cf><div class="aside" data-v-c4b0d3cf><div class="aside-curtain" data-v-c4b0d3cf></div><div class="aside-container" data-v-c4b0d3cf><div class="aside-content" data-v-c4b0d3cf><div class="VPDocAside" data-v-c4b0d3cf data-v-3f215769><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" data-v-3f215769 data-v-ff0f39c8><div class="content" data-v-ff0f39c8><div class="outline-marker" data-v-ff0f39c8></div><div class="outline-title" data-v-ff0f39c8>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-ff0f39c8><span class="visually-hidden" id="doc-outline-aria-label" data-v-ff0f39c8> Table of Contents for current page </span><ul class="root" data-v-ff0f39c8 data-v-8f12e865><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-3f215769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-c4b0d3cf><div class="content-container" data-v-c4b0d3cf><!--[--><!--]--><!----><main class="main" data-v-c4b0d3cf><div style="position:relative;" class="vp-doc _docs_server_development_code" data-v-c4b0d3cf><div><h1 id="source-code" tabindex="-1">Source Code <a class="header-anchor" href="#source-code" aria-label="Permalink to &quot;Source Code&quot;">​</a></h1><p>This article explains the package structure of the Turms server and the approximate source code implementation of each main functional module to help developers read the source code and understand the related process faster.</p><p>remind:</p><ol><li>The Turms server heavily uses the responsive framework of <a href="https://projectreactor.io/docs/core/release/reference" target="_blank" rel="noreferrer">reactor-core</a>. This article assumes that the reader has mastered responsive programming. If the reader has not mastered For responsive programming, it is recommended to learn and master <a href="https://projectreactor.io/docs/core/release/reference" target="_blank" rel="noreferrer">reactor-core</a> by yourself.</li><li>Turms will optimize the code from time to time. Some function names or function implementations may change slightly, but the idea will not change.</li><li>What the source code of each module does is usually much more than what is described below, but for the convenience of readers to understand, <strong>this article only selects the main process to explain, and omits a lot of details</strong>. If readers are interested in the details, they can read the source code after reading the relevant explanations in this article and have a general understanding of the main process to understand its specific implementation details.</li></ol><h2 id="project-structure" tabindex="-1">Project Structure <a class="header-anchor" href="#project-structure" aria-label="Permalink to &quot;Project Structure&quot;">​</a></h2><p>We often say that code is a document. Code allows readers to understand the implementation details and logical relationship of each function from a micro perspective, while a package is like a directory of documents. A good subcontract should clearly show the hierarchy and structure of the &quot;document&quot; at a macro level, so that readers can understand it. This article explains the package structure of the Turms server to help developers better understand the relationship and hierarchy between packages.</p><h3 id="background-extended-content" tabindex="-1">Background (extended content) <a class="header-anchor" href="#background-extended-content" aria-label="Permalink to &quot;Background (extended content)&quot;">​</a></h3><p>No matter what kind of subcontracting concept, in fact, there are only four basic subcontracting categories: by feature (Feature), by type (Type), by layer (Layer) and no subcontracting, and various upper-level designs Ideas are simply different combinations of these basic subcontracting categories.</p><p>In addition, even for the same project, different package structures are usually applicable at different development stages. We often say that the architecture is an evolutionary development, and the package classification actually needs an evolutionary development. For example, in the early stage of the Turms server, there were not many modules in total, but according to the idea of subcontracting a bunch of modules by the Turms server today, we designed the package structure for the early Turms server, and the result is: the readability of the package structure Not rising but falling, designing for the sake of design, that is, over-designing.</p><h3 id="subcontract-target-expanded-content" tabindex="-1">Subcontract target (expanded content) <a class="header-anchor" href="#subcontract-target-expanded-content" aria-label="Permalink to &quot;Subcontract target (expanded content)&quot;">​</a></h3><p>When doing subcontract design, you must have a clear goal, otherwise it is easy to fall into the situation of &quot;forcibly subcontracting in order to cover a certain package design&quot;, such as the service layer of some projects, first write the interface class and then write the implementation class, without thinking Why do we need such an interface in the design specification, or forcibly apply the DDD layered template, without thinking about whether some designs have seriously violated the established conventions, which leads to handicap when programming.</p><p>The main objectives of the subcontracting of the Turms server project are:</p><ul><li>Try to ensure high cohesion of functional feature modules and reduce the complexity of modules. This is mainly for the maintainability of the code to avoid falling into the very common <code>mixed design by feature+by type</code> or <code>mixed design by feature+by type+by layer</code>, because the hybrid design will both It makes the ownership of the code ambiguous, and also reduces the readability of the package structure due to the use of different subcontracting strategies under one layer of packages, which is not conducive to long-term maintenance.</li><li>Try to ensure the independence of the business sub-domain. This is mainly to draw clear business boundaries and make each module easy to read and change (additionally, turms-service will support deployment in various business domain combinations in the future, for example, turms-service can be deployed in the future It can also be deployed as a service in the user business domain, or as a service in the message business domain, or as a service in the user + message business domain, etc.).</li><li>The functional feature modules and business modules of the supporting domain must be separated. This is mainly to draw a clear boundary between the problem domain and the support domain.</li><li>Try to let developers guess the upstream and downstream relationship of the package through the package structure. This is mainly due to the readability of the code. In long-term programming practice, when we see that the package structure of medium and large projects does not have layered code, then we may have to go through the package or code several times before Infer possible upstream and downstream relationships of packages.</li><li>In the case of clear logic, try to make the package level less.</li></ul><p>In addition, when reading the package structure of various excellent open source projects, we will find that most of the well-known medium and large open source server projects may not do hierarchical design at all, and usually focus on subpackaging according to functional characteristics, with Subcontracting by type is supplemented by hybrid design, or by conventional MVC or DDD layered design. For these subcontracting ideas, we generally evaluate &quot;moderate, in line with conventions, but unsatisfactory&quot;, because they do not well meet the above-mentioned <code>subcontracting goals</code>, and many developers will also fall into the trap when reading the source code of these projects. In the case of &quot;don&#39;t know where to start&quot;, coding often encounters the problem of ambiguous attribution of code.</p><h3 id="subcontracting-idea" tabindex="-1">subcontracting idea <a class="header-anchor" href="#subcontracting-idea" aria-label="Permalink to &quot;subcontracting idea&quot;">​</a></h3><p>Various subcontracting concepts usually only provide ideas in ideal scenarios, and must not be directly applied blindly. When we design the package structure for the Turms server, we mainly refer to: the design concepts of various subcontracts, the practice and actual effects of excellent open source projects, conventional practices, project scale, project type, package scale, and long-term programming practices. experience.</p><p>Therefore, various subcontracting concepts are just &quot;reference suggestions&quot;. In actual operation, it is necessary to rely on long-term programming practice and experience to judge whether various designs are suitable for the actual situation of the Turms project, and to learn from each other&#39;s various subcontracting concepts , readers can also see many design concepts and even the shadow of DDD-based microservice design from the package structure of the Turms server project. Specifically, the subcontract diagram of the Turms server is as follows:</p><figure class="mermaid-diagram"></figure><p>The name in the frame above is the name of the package in the actual Turms server, and its connection is the logical relationship between packages. in:</p><p>The first layer is divided into layers, which are <code>access</code>, <code>domain</code>, <code>storage</code> and <code>infra</code>. Among them:</p><ul><li><p>access: The access layer is responsible for session management and request scheduling between administrators and clients. This layer will distribute user requests to the <code>access</code> layer of the <code>domain</code> layer.</p></li><li><p>domain: business domain layer, responsible for processing logic related to various business domains. The domain layer is divided into three layers: <code>access</code>, <code>service</code> and <code>repository</code> according to the common hierarchical subcontracting design.</p><ul><li><p>Among them, the relatively special one is the <code>access</code> layer in the <code>domain</code> layer. Because the upper layer of <code>service</code> not only has the Controller layer <code>admin</code> that dispatches administrator HTTP requests, but also the Controller layer <code>client</code> or <code>servicerequest</code> that dispatches client requests (for turms-gateway, it is <code>client</code> package, and For turms-service it is <code>servicerequest</code> package). Both share the Service layer, so a single accecss layer is used to cover both layers.</p></li><li><p>About why a <code>model</code> should be selected separately</p><p>For example, <code>dto</code> (Data Transfer Object)/<code>bo</code> (Business Object)/<code>po</code> (Persistent Object) in the above picture are all anemic models, only <code>model</code> is a hyperemic model, they not only store state (data) , also comes with some behaviors (logic), which are used to handle various high-cohesion logics, which are special, so they are subcontracted separately.</p></li><li><p>About the <code>rpc</code> package</p><p>Some domains (domain) have their own unique RPC requests, and these RPC requests will be grouped under this domain. For example, the RPC request <code>im.turms.server.common.domain.session.rpc.SetUserOfflineRequest</code> under the <code>Session</code> domain.</p><p>In addition, the implementation of cluster RPC is under the <code>im.turms.server.common.infra.cluster.service.rpc</code> package.</p></li></ul></li><li><p>storage: Storage layer, providing MongoDB client management and Redis client management, corresponding to <code>mongo</code> package and <code>redis</code> package respectively.</p></li><li><p>infra: Basic service layer, responsible for providing basic functions for <code>access</code> and <code>domain</code> layers, such as log processing, configuration management, etc. The infra layer is divided into packages according to functional characteristics.</p></li></ul><p>In summary, the subcontracting of the Turms server is actually very cleverly designed:</p><ul><li>Through the four layers of <code>access</code>, <code>domain</code>, <code>storage</code> and <code>infra</code>, developers can quickly understand the source code level of the Turms server based on the mastered MVC layered knowledge, and can clearly understand each What is the relationship between the layer package and the user session and user request.</li><li>The business domains of the <code>domain</code> layer can help developers quickly distinguish which business domains each Turms server has. The interior of each domain is based on the common MVC layered design, and developers can quickly understand the internal upstream and downstream logical relationships of a business domain based on previous knowledge.</li><li>The <code>infra</code> layer can help developers understand which functional modules are included in the support domain of the Turms server.</li></ul><p>Therefore, such a subcontracting level is actually relatively clear, which is conducive to long-term maintenance. In addition, readers may have seen the shadow of many subcontracting concepts from the above-mentioned subcontracting practice, and Turms only designs with reference to these concepts, and does not need to follow these subcontracting concepts.</p><p>Replenish:</p><ul><li>Regarding why the first-level package is not divided into modules (Java Modules), this is because there is no need to divide the modules at this stage, and the division of modules will also increase the complexity of the project structure. If it is not necessary, do not add entities.</li><li>Most of the anemia models on the Turms server are represented by Java&#39;s <code>record</code>, but some anemia models are still represented by <code>class</code> for performance reasons (whether a new object needs to be recreated to change a field).</li></ul><h3 id="request-processing-flow-process-between-packages" tabindex="-1">Request processing flow process between packages <a class="header-anchor" href="#request-processing-flow-process-between-packages" aria-label="Permalink to &quot;Request processing flow process between packages&quot;">​</a></h3><p>After understanding the Turms subcontracting design above, readers should have a clear understanding of the request processing process of the Turms server. Here we take the most classic &quot;client login&quot; as an example, and briefly talk about the relevant process from the perspective of the package (readers can read it in conjunction with the above sub-package diagram), to help readers understand the layered design of the package more clearly.</p><ul><li><p>When the client logs in, it must first establish a pure TCP or WebSocket connection with the turms-gateway server. At this time, the <code>access</code> layer handles the network connection, because it is a client connection, so it is the <code>access/client</code> layer (and not <code>access/admin</code>).</p></li><li><p>After the network connection is established, when the client sends a login request to turms-gateway, turms-gateway will pass the parsed request to the Controller of the <code>domain/session/access/client/controller</code> layer via the <code>access</code> layer for processing , the Controller will hand over the specific business logic to the Service at the <code>domain/session/access/client/service</code> layer for processing, and the Service will: 1. Hand over the query operation of the related MongoDB database to <code>domain/session/access The Repository at the /client/repository</code> layer is processed, and the Repository is just a splicing of related CRUD statements, and these statements will be passed to the MongoDB client implementation at the <code>storage/mongo</code> layer, and they will send the final request to the MongoDB server ; 2. Related Redis operations are handled by the <code>storage/redis</code> layer.</p><p>After the request is processed, it will return in sequence through the callback and according to the upstream and downstream relationship of the package.</p></li><li><p>As for the <code>infra</code> layer and various other subpackages, most of them provide support for various capabilities for the above layers, such as the <code>infra/logging</code> log package and the <code>infra/cluster</code> cluster implementation package.</p></li></ul><p>The processing flow of other types of requests (administrator HTTP requests, client business requests based on TCP/WebSocket connections) is roughly the same as above, and readers can infer other cases by themselves.</p><p>The following chapters will continue to explain the processing flow of client requests from a more detailed source code perspective.</p><h2 id="client-request-processing-flow" tabindex="-1">Client request processing flow <a class="header-anchor" href="#client-request-processing-flow" aria-label="Permalink to &quot;Client request processing flow&quot;">​</a></h2><p>Before reading the following, readers are advised to read <a href="https://turms-im.github.io/docs/design/architecture#%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AE%BF%E9%97%AE%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B" target="_blank" rel="noreferrer">Standard Process for Client Access to Server</a>, first understand the design ideas behind it from the perspective of architecture, so that it is not easy to &quot;get lost&quot; when reading the source code.</p><p>Request model: <code>im.turms.server.common.access.client.dto.request.TurmsRequest</code></p><p>Response and notification model: <code>im.turms.server.common.access.client.dto.notification.TurmsNotification</code></p><h3 id="uml-sequence-diagram" tabindex="-1">UML sequence diagram <a class="header-anchor" href="#uml-sequence-diagram" aria-label="Permalink to &quot;UML sequence diagram&quot;">​</a></h3><figure class="mermaid-diagram"></figure><p>###turms-gateway</p><p>Introduction: It is used to maintain the network connection with the client, maintain the application layer session, and send most of the business requests to the turms-service server.</p><h4 id="network-layer-configuration" tabindex="-1">Network layer configuration <a class="header-anchor" href="#network-layer-configuration" aria-label="Permalink to &quot;Network layer configuration&quot;">​</a></h4><ol><li><p>Start the server that receives the client request</p><p>TCP server: <code>im.turms.gateway.access.client.tcp.TcpServerFactory#create</code></p><p>WebSocket server: <code>im.turms.gateway.access.client.websocket.WebSocketServerFactory#create</code></p><p>The main functions of these two functions are: based on the <code>reactor-netty</code> library, bind the listening address of the server, configure the EventLoop thread pool, (optional) configure SSL, enable related metrics, and other routine server-related work.</p></li><li><p>For a pure TCP connection (not a prepared WebSocket connection), bind the codec Handlers to the newly established TCP connection</p><p>In the <code>im.turms.gateway.access.client.tcp.TcpServerFactory#create</code> function, through the following callback, bind the corresponding codec instances of <code>TurmsRequest</code> and <code>TurmsNotification</code> to the new TCP connection.</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">doOnConnection</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">connection </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// Inbound</span></span>
<span class="line"><span style="color:#A6ACCD;">    connection</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">addHandlerLast</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">varintLengthBasedFrameDecoder</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> CodecFactory</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getExtendedVarintLengthBasedFrameDecoder</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">maxFrameLength</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// Outbound</span></span>
<span class="line"><span style="color:#A6ACCD;">    connection</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">addHandlerLast</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">varintLengthFieldPrepender</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> CodecFactory</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getVarintLengthFieldPrepender</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">    connection</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">addHandlerLast</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">protobufFrameEncoder</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> CodecFactory</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getProtobufFrameEncoder</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#89DDFF;">});</span></span></code></pre></div></li><li><p>For a WebSocket connection, first monitor and verify the HTTP Upgrade request, and then upgrade to a WebSocket connection</p><p>In the <code>im.turms.gateway.access.client.websocket.WebSocketServerFactory#create</code> function, bind the HTTP monitoring callback through the following code:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">.handle(getHttpRequestHandler(handler, serverSpec))</span></span></code></pre></div><p>The <code>getHttpRequestHandler</code> function comes from <code>im.turms.gateway.access.client.websocket.WebSocketServerFactory#getHttpRequestHandler</code>, this callback is used to verify the HTTP request, if it is a legal HTTP Upgrade request, the connection will be upgraded to WebSocket connect.</p></li></ol><p>At this point, the operation of the pure network layer is basically completed, and the next step is to connect the network layer and the business logic layer.</p><h4 id="connection-between-network-layer-and-business-logic-layer" tabindex="-1">Connection between network layer and business logic layer <a class="header-anchor" href="#connection-between-network-layer-and-business-logic-layer" aria-label="Permalink to &quot;Connection between network layer and business logic layer&quot;">​</a></h4><ol><li><p>The network layer and the business logic layer are bound through the function interface: <code>im.turms.gateway.access.client.common.connection.ConnectionListener#onAdded</code>. The main binding content is: the input byte stream of the TCP connection , Output byte stream, callback function when closed.</p><p>For the TCP server, under the <code>im.turms.gateway.access.client.tcp.TcpServerFactory#create</code> function, pass <code>.handle((in, out) -&gt; connectionListener.onAdded((Connection) in, false, in .receive(), out, ((Connection) in).onDispose()))</code> for binding.</p><p>For the WebSocket server, under the <code>im.turms.gateway.access.client.websocket.WebSocketServerFactory#create</code> function, bind via <code>connectionListener.onAdded((Connection) in, true, inbound, out, onClose)</code>.</p></li><li><p>The above <code>connectionListener.onAdded</code> will call the following <code>UserSessionAssembler#bindConnectionWithSessionWrapper</code> callback function to coordinate the logic of processing the input byte stream and the output byte stream, and from a global perspective, these byte data are essentially It is the <code>request</code>, <code>response</code> and <code>notification</code> of the upper business layer, so this part of the code is the focus of the interaction between the server and the client, and we will look back at this code later. Its source code is as follows:</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">ConnectionListener</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">bindConnectionWithSessionWrapper</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">connection</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> isWebSocketConnection</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> in</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> out</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> onClose</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">InetSocketAddress</span><span style="color:#A6ACCD;"> address </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">InetSocketAddress</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> connection</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">address</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">NetConnection</span><span style="color:#A6ACCD;"> netConnection </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">createConnection</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">connection</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">UserSessionWrapper</span><span style="color:#A6ACCD;"> sessionWrapper </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">UserSessionWrapper</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">netConnection</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> address</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> closeIdleConnectionAfterSeconds</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">                userSession </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> userSession</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setNotificationConsumer</span><span style="color:#89DDFF;">((</span><span style="color:#A6ACCD;">turmsNotificationBuffer</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> tracingContext</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                    turmsNotificationBuffer</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">touch</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">turmsNotificationBuffer</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                    turmsNotificationBuffer </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> turmsNotificationBuffer</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">duplicate</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#C792EA;">NettyOutbound</span><span style="color:#A6ACCD;"> outbound </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> isWebSocketConnection</span></span>
<span class="line"><span style="color:#A6ACCD;">                            </span><span style="color:#89DDFF;font-style:italic;">?</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sendObject</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">BinaryWebSocketFrame</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">turmsNotificationBuffer</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">                            </span><span style="color:#89DDFF;font-style:italic;">:</span><span style="color:#A6ACCD;"> out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sendObject</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">turmsNotificationBuffer</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> Mono</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">from</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">outbound</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">                            </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">doOnError</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">t </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">handleConnectionError</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">t</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> netConnection</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> userSession</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> tracingContext</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}));</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">respondToRequests</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">connection</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> isWebSocketConnection</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> in</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> out</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> sessionWrapper</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">tryRemoveSessionInfoOnConnectionClosed</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">onClose</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> sessionWrapper</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><p>Among them, <code>userSession.setNotificationConsumer</code> is used to set the callback function for listening to <code>notification</code>, and the callback function will send the received <code>notification</code> byte data to the client. This callback function is also the key point, because the process of sending <code>notification</code> from turms-service to turms-gateway we will talk about later will eventually return here.</p><p>The <code>respondToRequests</code> function is used to monitor the <code>request</code> input byte stream, and forward the returned <code>response</code> output byte stream after the downstream code has processed the <code>request</code>. The source code of this function is as follows:</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">respondToRequests</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Connection</span><span style="color:#A6ACCD;"> connection</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">                       </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> isWebSocketConnection</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">                       </span><span style="color:#C792EA;">Flux</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">ByteBuf</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> in</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">                       </span><span style="color:#C792EA;">Netty</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Outbound</span><span style="color:#A6ACCD;"> out</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">                       </span><span style="color:#C792EA;">UserSessionWrapper</span><span style="color:#A6ACCD;"> sessionWrapper</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    in</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">doOnNext</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">requestData </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">connection</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">isDisposed</span><span style="color:#89DDFF;">())</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">                requestData</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">retain</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#C792EA;">TracingContext</span><span style="color:#A6ACCD;"> ctx </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">TracingContext</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">                clientRequestDispatcher</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">handleRequest</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">sessionWrapper</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> requestData</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">                        </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">onErrorResume</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">throwable </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                            ctx</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">updateThreadContext</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">                            </span><span style="color:#82AAFF;">handleNotificationError</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">throwable</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> sessionWrapper</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getUserSession</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">                            </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> Mono</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">empty</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">                        </span><span style="color:#89DDFF;">})</span></span>
<span class="line"><span style="color:#A6ACCD;">                        </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">flatMap</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">turmsNotificationBuffer </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                            turmsNotificationBuffer</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">touch</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">turmsNotificationBuffer</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                            turmsNotificationBuffer </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> turmsNotificationBuffer</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">duplicate</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">                            </span><span style="color:#C792EA;">NettyOutbound</span><span style="color:#A6ACCD;"> outbound </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> isWebSocketConnection</span></span>
<span class="line"><span style="color:#A6ACCD;">                                    </span><span style="color:#89DDFF;font-style:italic;">?</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sendObject</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">BinaryWebSocketFrame</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">turmsNotificationBuffer</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">                                    </span><span style="color:#89DDFF;font-style:italic;">:</span><span style="color:#A6ACCD;"> out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sendObject</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">turmsNotificationBuffer</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                            </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> Mono</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">from</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">outbound</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                        </span><span style="color:#89DDFF;">})</span></span>
<span class="line"><span style="color:#A6ACCD;">                        </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">contextWrite</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">context </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> context</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">put</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">TracingContext</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">CTX_KEY_NAME</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> ctx</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">                        </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">doFinally</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">signal </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> ctx</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">clearThreadContext</span><span style="color:#89DDFF;">())</span></span>
<span class="line"><span style="color:#A6ACCD;">                        </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">subscribe</span><span style="color:#89DDFF;">(null,</span><span style="color:#A6ACCD;"> t </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">handleConnectionError</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">t</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> sessionWrapper</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getConnection</span><span style="color:#89DDFF;">(),</span></span>
<span class="line"><span style="color:#A6ACCD;">                                sessionWrapper</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getUserSession</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> ctx</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">})</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">then</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">subscribe</span><span style="color:#89DDFF;">(null,</span><span style="color:#A6ACCD;"> t </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">handleConnectionError</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">t</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> sessionWrapper</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getConnection</span><span style="color:#89DDFF;">(),</span></span>
<span class="line"><span style="color:#A6ACCD;">                    sessionWrapper</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getUserSession</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> TracingContext</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> NOOP</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><p>Among them, <code>respondToRequests</code> at <code>clientRequestDispatcher.handleRequest(sessionWrapper, requestData)</code>, submits the byte stream <code>ByteBuf</code> of <code>request</code> to the downstream business logic layer for processing; in <code>.flatMap(turmsNotificationBuffer -&gt; {</code> At the callback, output the requested <code>response</code> byte stream.</p><p>So far, the data of the network layer has been conveyed to the downstream business layer, and the work of <code>receiving requests</code> at the network layer is over, and the next steps are related operations of the business layer.</p><p>Note: Although the work of <code>receiving request</code> at the network layer is over, the network layer will also process the <code>response</code> and <code>notification</code> byte data sent back by the downstream business logic layer, and the ending code has been mentioned above , so I won’t go into details.</p></li></ol><h4 id="business-layer-request-scheduling-layer" tabindex="-1">Business layer - request scheduling layer <a class="header-anchor" href="#business-layer-request-scheduling-layer" aria-label="Permalink to &quot;Business layer - request scheduling layer&quot;">​</a></h4><p>Through the operation of the network layer, came to <code>im.turms.gateway.access.client.common.ClientRequestDispatcher#handleRequest</code>. This function completes: dispatching heartbeat requests and business requests; simply verifying the request, if it is an illegal request, try to block the user ID and IP, etc.</p><p>Although there are many codes in this function, it is actually very easy to read. Our main concern here is the line of code <code>handleServiceRequest(sessionWrapper, request, serviceRequestBuffer, tracingContext)</code>. The main source code of <code>handleServiceRequest</code> function is as follows:</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">switch</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">requestType</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#89DDFF;font-style:italic;">case</span><span style="color:#A6ACCD;"> CREATE_SESSION_REQUEST </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> sessionController</span></span>
<span class="line"><span style="color:#A6ACCD;">             </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">handleCreateSessionRequest</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">sessionWrapper</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> request</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">createSessionRequest</span><span style="color:#89DDFF;">())</span></span>
<span class="line"><span style="color:#A6ACCD;">             </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">map</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">result </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getNotificationFromHandlerResult</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">result</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> request</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">requestId</span><span style="color:#89DDFF;">()));</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#89DDFF;font-style:italic;">case</span><span style="color:#A6ACCD;"> DELETE_SESSION_REQUEST </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> sessionController</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">handleDeleteSessionRequest</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">sessionWrapper</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#89DDFF;font-style:italic;">default</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">         serviceRequestBuffer</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">retain</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#89DDFF;font-style:italic;">yield</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">handleServiceRequest</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">sessionWrapper</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> request</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> serviceRequestBuffer</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span></code></pre></div><ul><li><p>The <code>CREATE_SESSION_REQUEST</code> and <code>DELETE_SESSION_REQUEST</code> two requests that turms-gateway can handle by itself are handed over to turms-gateway’s own Controller layer for processing, that is, <code>SessionController</code>, which is mainly through <code>im.turms.gateway. The domain.session.service.SessionService</code> service interacts with the Redis server, and executes the logic related to the user&#39;s <code>login</code> and <code>logout</code>. Since business logic is not the focus of this article, it will not be discussed here.</p><p>After the logic of the Controller and Service are all processed, a <code>TurmsNotification</code> object is returned, and the byte data is finally sent to the client through the above-mentioned network layer and codec Handlers.</p></li><li><p>For all other requests, turms-gateway passes the above <code>handleServiceRequest</code> function, and finally sends the client request to turms-service via RPC for processing. Among them, the <code>handleServiceRequest</code> function will call <code>node.getRpcService().requestResponse(request)</code> to wrap the RPC request <code>im.turms.server.common.access.servicerequest&#39; with the byte data requested by the client through the self-developed RPC framework .rpc.HandleServiceRequest</code>is sent to turms-service for processing. The implementation of specific RPC is not the focus of this article, so I won’t talk about it here.</p><p>After turms-service finishes processing the request, it will return a <code>im.turms.server.common.access.servicerequest.dto.ServiceResponse</code>, which will be in the above <code>im.turms.gateway.domain.servicerequest.service.ServiceRequestService# In the handleServiceRequest</code> function, <code>ServiceResponse</code> is converted to <code>TurmsNotification</code> through the following <code>getNotificationFromResponse</code> function, and then the byte data is finally sent to the client through the above-mentioned network layer and codec Handlers:</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> node</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getRpcService</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">requestResponse</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">request</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">defaultIfEmpty</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">REQUEST_RESPONSE_NO_CONTENT</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">map</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">response </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getNotificationFromResponse</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">response</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> serviceRequest</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getRequestId</span><span style="color:#89DDFF;">()));</span></span></code></pre></div></li></ul><p>So far, the processing logic of turms-gateway&#39;s client request has been explained, and the following will explain how turms-service handles the RPC request sent by upstream turms-gateway. ###turms-service</p><p>(RPC implementation belongs to the implementation content of &quot;cluster service&quot;, so we won&#39;t explain it here)</p><ol><li><p>Request scheduling layer</p><p>After processing at the RPC layer, turms-service will first get the byte data requested by the client through <code>im.turms.service.access.servicerequest.dispatcher.ServiceRequestDispatcher#dispatch</code>. This function will call the <code>im.turms.service.access.servicerequest.dispatcher.ServiceRequestDispatcher#dispatch0</code> function to complete such as: request verification, client ban, judgment of server monitoring status, triggering plug-ins and calling Controller layer interface functions, triggering upstream tasks.</p><p>Although there are many codes in this function, it is actually relatively easy to read. Here we mainly see the line of code <code>result = result.switchIfEmpty(Mono.defer(() -&gt; handler.handle(lastClientRequest)));</code> , the <code>handler#handle</code> function is actually the <code>im.turms.service.access.servicerequest.dispatcher.ClientRequestHandler#handle</code> function, and the implementation of the <code>handle</code> function is the implementation of each Controller layer interface.</p></li><li><p>Request the Controller layer</p><p>After each Controller gets the passed <code>im.turms.service.access.servicerequest.dto.ClientRequest</code> object through the above <code>handle</code> function, it starts to execute the relevant business logic, and sends various CRUD to the MongoDB server ask. Business logic processing is not the focus of this article, so I won’t explain it here. After the Controller layer finishes processing the relevant business logic, it will return an <code>im.turms.service.access.servicerequest.dto.RequestHandlerResult</code> object. In simple terms, this object describes: the <code>response</code> to be sent back to the client, and the <code>notification</code> to be sent to other users (for example: if the request is a request to send a group chat message, then for the receiving client of the message, These output byte streams sent to them are <code>notifications</code>).</p><p>For <code>response</code>, the byte data will be sent back to turms-gateway through the above RPC operation, and turms-gateway will pass <code>.flatMap(turmsNotificationBuffer -&gt; { </code>Callback function, finally send the response byte data to the client.</p></li></ol><p>At this point, a request has been processed.</p><h2 id="notification-issued" tabindex="-1">Notification issued <a class="header-anchor" href="#notification-issued" aria-label="Permalink to &quot;Notification issued&quot;">​</a></h2><p>Notification model: <code>im.turms.server.common.access.client.dto.notification.TurmsNotification</code></p><p><code>Notification</code> is only generated by turms-service, turms-gateway will not generate <code>notification</code> by itself, and will only forward <code>notification</code>.</p><h3 id="uml-sequence-diagram-1" tabindex="-1">UML sequence diagram <a class="header-anchor" href="#uml-sequence-diagram-1" aria-label="Permalink to &quot;UML sequence diagram&quot;">​</a></h3><figure class="mermaid-diagram"></figure><p>###turms-service</p><p>In the above, we mentioned that turms-service will return an <code>im.turms.service.access.servicerequest.dto.RequestHandlerResult</code> object after processing the business logic requested by the client, which also contains: notification data and An array of user IDs that need to receive notifications. The object will be passed to the following callback in the <code>im.turms.service.access.servicerequest.dispatcher.ServiceRequestDispatcher#dispatch0</code> function:</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">doOnEach</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">signal </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(!</span><span style="color:#A6ACCD;">signal</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">isOnNext</span><span style="color:#89DDFF;">())</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#C792EA;">RequestHandlerResult</span><span style="color:#A6ACCD;"> requestResult </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> signal</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">requestResult </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> requestResult</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">code</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> ResponseStatusCode</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">OK</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#82AAFF;">notifyRelatedUsersOfAction</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">requestResult</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> userId</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> deviceType</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">             </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">contextWrite</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">signal</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getContextView</span><span style="color:#89DDFF;">())</span></span>
<span class="line"><span style="color:#A6ACCD;">             </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">subscribe</span><span style="color:#89DDFF;">(null,</span><span style="color:#A6ACCD;"> t </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                 </span><span style="color:#89DDFF;font-style:italic;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">TracingCloseableContext</span><span style="color:#A6ACCD;"> ignored </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> context</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">asCloseable</span><span style="color:#89DDFF;">())</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                     LOGGER</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">error</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Failed to notify related users of the action</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> t</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                 </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">             </span><span style="color:#89DDFF;">});</span></span>
<span class="line"><span style="color:#89DDFF;">})</span></span></code></pre></div><p>Among them, the <code>notifyRelatedUsersOfAction</code> function will asynchronously send a <code>notification</code> to related users, and its code is implemented as follows:</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">Mono</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Void</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">notifyRelatedUsersOfAction</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#C792EA;">RequestHandlerResult</span><span style="color:#A6ACCD;"> result</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#C792EA;">Long</span><span style="color:#A6ACCD;"> requesterId</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#C792EA;">DeviceType</span><span style="color:#A6ACCD;"> requesterDevice</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#C792EA;">TurmsRequest</span><span style="color:#A6ACCD;"> dataForRecipients </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> result</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">dataForRecipients</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#C792EA;">Set</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">Long</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> recipients </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> result</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">recipients</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">dataForRecipients </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> recipients</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">isEmpty</span><span style="color:#89DDFF;">())</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> Mono</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">empty</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#C792EA;">TurmsNotification</span><span style="color:#A6ACCD;"> notificationForRecipients </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">TurmsNotification</span></span>
<span class="line"><span style="color:#A6ACCD;">             </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">newBuilder</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">             </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setRelayedRequest</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">dataForRecipients</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">             </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setRequesterId</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">requesterId</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">             </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">build</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#C792EA;">ByteBuf</span><span style="color:#A6ACCD;"> notificationByteBuf </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> ProtoUtil</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getDirectByteBuffer</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">notificationForRecipients</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">result</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">forwardDataForRecipientsToOtherSenderOnlineDevices</span><span style="color:#89DDFF;">())</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">         notificationByteBuf</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">retain</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#C792EA;">Mono</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">Boolean</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> notifyRequesterMono </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> outboundMessageService</span></span>
<span class="line"><span style="color:#A6ACCD;">                 </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">forwardNotification</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">notificationForRecipients</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> notificationByteBuf</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> requesterId</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> requesterDevice</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#C792EA;">Mono</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">Boolean</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> notifyRecipientsMono </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> outboundMessageService</span></span>
<span class="line"><span style="color:#A6ACCD;">                 </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">forwardNotification</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">notificationForRecipients</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> notificationByteBuf</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> recipients</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> Mono</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">when</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">notifyRequesterMono</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> notifyRecipientsMono</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">                 </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">doFinally</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">signal </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> notificationByteBuf</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">release</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> outboundMessageService</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">forwardNotification</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">notificationForRecipients</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> notificationByteBuf</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> recipients</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">             </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">then</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><p>We mainly look at the <code>outboundMessageService.forwardNotification</code> function, which will first pull the notification from the local cache or the Redis server to receive the user ID through the <code>im.turms.server.common.domain.session.service.UserStatusService#getDeviceAndNodeIdMapByUserId</code> function The turms-gateway server node ID, after getting these node IDs, and then through the <code>im.turms.service.domain.message.service.OutboundMessageService#forwardClientMessageToNodes(...)</code> function, the <code>notification</code> will be implemented through RPC, Forward it to these nodes for specific notification delivery operations. The specific code is implemented as follows:</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">Mono</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Boolean</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">forwardNotification</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">TurmsNotification</span><span style="color:#A6ACCD;"> notificationForLogging</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">ByteBuf</span><span style="color:#A6ACCD;"> notificationData</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">Long</span><span style="color:#A6ACCD;"> recipientId</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">DeviceType</span><span style="color:#A6ACCD;"> excludedDeviceType</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> userStatusService</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getDeviceToNodeIdMapByUserId</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">recipientId</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">doOnError</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">t </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> notificationData</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">release</span><span style="color:#89DDFF;">())</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">flatMap</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">deviceTypeAndNodeIdMap </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">Set</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> nodeIds </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> CollectionUtil</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">newSetWithExpectedSize</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">deviceTypeAndNodeIdMap</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">size</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Map</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">Entry</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">DeviceType</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> entry </span><span style="color:#89DDFF;font-style:italic;">:</span><span style="color:#A6ACCD;"> deviceTypeAndNodeIdMap</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">entrySet</span><span style="color:#89DDFF;">())</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">DeviceType</span><span style="color:#A6ACCD;"> deviceType </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> entry</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getKey</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">deviceType </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> excludedDeviceType</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        nodeIds</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">add</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">entry</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getValue</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">nodeIds</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">isEmpty</span><span style="color:#89DDFF;">())</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        notificationData</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">release</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> Mono</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">just</span><span style="color:#89DDFF;">(false);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">Mono</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">Boolean</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> mono </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">forwardClientMessageToNodes</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">notificationData</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> nodeIds</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> recipientId</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">tryLogNotification</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">mono</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> notificationForLogging</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">})</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">switchIfEmpty</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">Mono</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">fromCallable</span><span style="color:#89DDFF;">(()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        notificationData</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">release</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}));</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span></code></pre></div><p>###turms-gateway</p><p>After the <code>notification</code> is forwarded by RPC, turms-gateway will first obtain the <code>notification</code> word sent by turms-service in <code>im.turms.gateway.domain.notification.service.NotificationService#sendNotificationToLocalClients(...)</code> function section data. This function will call <code>userSession.sendNotification(wrappedNotificationData, tracingContext)</code> to send the notification data to the batch of user sessions. The <code>sendNotification</code> function is what we let readers pay attention to before, in the callback function of <code>im.turms.gateway.access.client.common.UserSessionAssembler#bindConnectionWithSessionWrapper</code>, this function completes the byte data of the notification through <code>out.sendObject</code> Issued. The specific code is as follows:</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">UserSessionWrapper</span><span style="color:#A6ACCD;"> sessionWrapper </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">UserSessionWrapper</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">netConnection</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> address</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> closeIdleConnectionAfterSeconds</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">         userSession </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> userSession</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setNotificationConsumer</span><span style="color:#89DDFF;">((</span><span style="color:#A6ACCD;">turmsNotificationBuffer</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> tracingContext</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">             turmsNotificationBuffer</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">touch</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">turmsNotificationBuffer</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">             turmsNotificationBuffer </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> turmsNotificationBuffer</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">duplicate</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">             </span><span style="color:#C792EA;">NettyOutbound</span><span style="color:#A6ACCD;"> outbound </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> isWebSocketConnection</span></span>
<span class="line"><span style="color:#A6ACCD;">                     </span><span style="color:#89DDFF;font-style:italic;">?</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sendObject</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">BinaryWebSocketFrame</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">turmsNotificationBuffer</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">                     </span><span style="color:#89DDFF;font-style:italic;">:</span><span style="color:#A6ACCD;"> out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sendObject</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">turmsNotificationBuffer</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">             </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> Mono</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">from</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">outbound</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">                     </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">doOnError</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">t </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">handleConnectionError</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">t</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> netConnection</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> userSession</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> tracingContext</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#89DDFF;">}));</span></span></code></pre></div><p>At this point, the <code>Notification</code> has been sent.</p><h2 id="cluster-implementation" tabindex="-1">Cluster implementation <a class="header-anchor" href="#cluster-implementation" aria-label="Permalink to &quot;Cluster implementation&quot;">​</a></h2><p>Before reading the following source code, readers are advised to read <a href="https://turms-im.github.io/docs/server/module/cluster" target="_blank" rel="noreferrer">Cluster Design and Implementation</a> to understand the basic design and responsibilities of cluster services .</p><h3 id="service-registration-and-discovery" tabindex="-1">Service registration and discovery <a class="header-anchor" href="#service-registration-and-discovery" aria-label="Permalink to &quot;Service registration and discovery&quot;">​</a></h3><p>TODO</p><h3 id="network-connection-service" tabindex="-1">Network connection service <a class="header-anchor" href="#network-connection-service" aria-label="Permalink to &quot;Network connection service&quot;">​</a></h3><p>TODO</p><p>###RPC</p><p>This article will continue to explain the RPC request example mentioned in the &quot;Client Request Processing Process&quot; above, that is: turms-gateway sends the RPC request of <code>HandleServiceRequest</code> to turms-service.</p><h4 id="rpc-sender-of-handleservicerequest" tabindex="-1">RPC sender of HandleServiceRequest <a class="header-anchor" href="#rpc-sender-of-handleservicerequest" aria-label="Permalink to &quot;RPC sender of HandleServiceRequest&quot;">​</a></h4><h5 id="uml-sequence-diagram-2" tabindex="-1">UML sequence diagram <a class="header-anchor" href="#uml-sequence-diagram-2" aria-label="Permalink to &quot;UML sequence diagram&quot;">​</a></h5><figure class="mermaid-diagram"></figure><h5 id="business-layer" tabindex="-1">Business Layer <a class="header-anchor" href="#business-layer" aria-label="Permalink to &quot;Business Layer&quot;">​</a></h5><p>Following the above, turms-gateway will send <code>HandleServiceRequest</code> to turms-service through the <code>im.turms.gateway.domain.servicerequest.service.ServiceRequestService#handleServiceRequest(...)</code> function, and this function will call the RPC service<code> The RpcService#requestResponse</code> function delegates the processing logic of the RPC request to the downstream RPC service for execution. The specific code is as follows:</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">Mono</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">TurmsNotification</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">handleServiceRequest</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">ServiceRequest</span><span style="color:#A6ACCD;"> serviceRequest</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// Validate</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">Long</span><span style="color:#A6ACCD;"> userId </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> serviceRequest</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getUserId</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">DeviceType</span><span style="color:#A6ACCD;"> deviceType </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> serviceRequest</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getDeviceType</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">UserSession</span><span style="color:#A6ACCD;"> session</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        session </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> sessionService</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getLocalUserSession</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">userId</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> deviceType</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">catch</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Exception</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">e</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> Mono</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">error</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">ResponseException</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">ResponseStatusCode</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">INVALID_REQUEST</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getMessage</span><span style="color:#89DDFF;">()));</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">session </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> ResponseExceptionPublisherPool</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">sendRequestFromNonExistingSession</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// Update heartbeat</span></span>
<span class="line"><span style="color:#A6ACCD;">        sessionService</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">updateHeartbeatTimestamp</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">session</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// Forward request</span></span>
<span class="line"><span style="color:#A6ACCD;">        serviceRequest</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getTurmsRequestBuffer</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">retain</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">HandleServiceRequest</span><span style="color:#A6ACCD;"> request </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">HandleServiceRequest</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">serviceRequest</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> node</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getRpcService</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">requestResponse</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">request</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">defaultIfEmpty</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">REQUEST_RESPONSE_NO_CONTENT</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">map</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">response </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getNotificationFromResponse</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">response</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> serviceRequest</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getRequestId</span><span style="color:#89DDFF;">()));</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">catch</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Exception</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">e</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> Mono</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">error</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">finally</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        serviceRequest</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getTurmsRequestBuffer</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">release</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span></code></pre></div><h5 id="rpc-layer-logic-layer" tabindex="-1">RPC layer - logic layer <a class="header-anchor" href="#rpc-layer-logic-layer" aria-label="Permalink to &quot;RPC layer - logic layer&quot;">​</a></h5><p>Since the function caller does not specify the RPC receiving node requested by <code>HandleServiceRequest</code>, the <code>requestResponse</code> function will first obtain a batch of Nodes that can handle the RPC request, after judging the health status of these nodes, if there is no healthy node, an exception will be thrown, otherwise the RPC request will be passed through <code>im.turms.server.common.infra.cluster.service .codec.CodecService#serializeWithoutCodecId</code> is encoded into byte data, and the byte data is sent to the downstream network layer through the function <code>endpoint.sendRequest(request, requestBody)</code>. The specific source code of <code>requestResponse0</code> is as follows:</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">T</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Mono</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">T</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">requestResponse0</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">RpcEndpoint</span><span style="color:#A6ACCD;"> endpoint</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">                              </span><span style="color:#C792EA;">RpcRequest</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">T</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> request</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">                              </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Nullable</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Duration</span><span style="color:#A6ACCD;"> timeout</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#89DDFF;font-style:italic;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#82AAFF;">assertCurrentNodeIsAllowedToSend</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">request</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">catch</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Exception</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">e</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">         request</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">release</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> Mono</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">error</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">timeout </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">         timeout </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> defaultRequestTimeoutDuration</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#C792EA;">Mono</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">T</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> mono </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Mono</span></span>
<span class="line"><span style="color:#A6ACCD;">             </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">deferContextual</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">context </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                 </span><span style="color:#82AAFF;">addTraceIdToRequestFromContext</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">context</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> request</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                 </span><span style="color:#C792EA;">ByteBuf</span><span style="color:#A6ACCD;"> requestBody</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                 </span><span style="color:#89DDFF;font-style:italic;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                     requestBody </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> codecService</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">serializeWithoutCodecId</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">request</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                 </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">catch</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Exception</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">e</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                     request</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">release</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">                     </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> Mono</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">error</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">IllegalStateException</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Failed to encode the</span></span>
<span class="line"><span style="color:#C3E88D;">                 }</span></span>
<span class="line"><span style="color:#C3E88D;">                 return endpoint. sendRequest(request, requestBody);</span></span>
<span class="line"><span style="color:#C3E88D;">             })</span></span>
<span class="line"><span style="color:#C3E88D;">             .timeout(timeout)</span></span>
<span class="line"><span style="color:#C3E88D;">             .name(METRICS_NAME_RPC_REQUEST)</span></span>
<span class="line"><span style="color:#C3E88D;">             .tag(METRICS_TAG_REQUEST_NAME, request.name())</span></span>
<span class="line"><span style="color:#C3E88D;">             .tag(METRICS_TAG_REQUEST_TARGET_NODE_ID, endpoint.getNodeId());</span></span>
<span class="line"><span style="color:#C3E88D;">     Tag tag = request. tag();</span></span>
<span class="line"><span style="color:#C3E88D;">     if (tag != null) {</span></span>
<span class="line"><span style="color:#C3E88D;">         mono = mono. tag(tag. getKey(), tag. getValue());</span></span>
<span class="line"><span style="color:#C3E88D;">     }</span></span>
<span class="line"><span style="color:#C3E88D;">     return mono</span></span>
<span class="line"><span style="color:#C3E88D;">             .metrics()</span></span>
<span class="line"><span style="color:#C3E88D;">             .onErrorMap(t -&gt; mapThrowable(t, request));</span></span>
<span class="line"><span style="color:#C3E88D;">}</span></span></code></pre></div><h5 id="rpc-layer-network-layer" tabindex="-1">RPC layer - network layer <a class="header-anchor" href="#rpc-layer-network-layer" aria-label="Permalink to &quot;RPC layer - network layer&quot;">​</a></h5><p>After the RPC request is encoded into byte data by the upstream RPC logic layer, it will be passed to the <code>im.turms.server.common.infra.cluster.service.rpc.RpcEndpoint#sendRequest</code> function, which will pass <code>RpcFrameEncoder.INSTANCE .encodeRequest(request, requestBody)</code> appends the two bytes of <code>request type ID</code> and <code>request ID</code> to the byte data, so that the RPC peer can decode according to the <code>request type ID</code>, and pass <code>Request ID</code> returns the corresponding response, and finally sends the byte stream data to the RPC peer. The specific code implementation of <code>sendRequest</code> is as follows:</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">T</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Mono</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">T</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">sendRequest</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">RpcRequest</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">T</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> request</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">ByteBuf</span><span style="color:#A6ACCD;"> requestBody</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#C792EA;">ChannelOperations</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">?</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">?</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> conn </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> connection</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getConnection</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">requestBody</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">refCnt</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> Mono</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">error</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">IllegalReferenceCountException</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">The request body has been released</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">conn</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">isDisposed</span><span style="color:#89DDFF;">())</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">         requestBody</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">release</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> Mono</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">error</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ClosedChannelException</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">     Sinks</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> One</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">T</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> sink </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Sinks</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">one</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#89DDFF;font-style:italic;">while</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(true)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> requestId </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">generateRandomId</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#C792EA;">Sinks</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">One</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">?</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> previous </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> pendingRequestMap</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">putIfAbsent</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">requestId</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> sink</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">previous </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">             </span><span style="color:#89DDFF;font-style:italic;">continue</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">         request</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setRequestId</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">requestId</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#C792EA;">ByteBuf</span><span style="color:#A6ACCD;"> buffer</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#89DDFF;font-style:italic;">try</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">             buffer </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> RpcFrameEncoder</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">INSTANCE</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">encodeRequest</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">request</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> requestBody</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">catch</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Exception</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">e</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">             requestBody</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">release</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">             </span><span style="color:#82AAFF;">resolveRequest</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">requestId</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">IllegalStateException</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Failed to encode request</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#A6ACCD;">             </span><span style="color:#89DDFF;font-style:italic;">break</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">         conn</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">sendObject</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">buffer</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">                 </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">then</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">                 </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">subscribe</span><span style="color:#89DDFF;">(null,</span><span style="color:#A6ACCD;"> t </span><span style="color:#C792EA;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">resolveRequest</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">requestId</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null,</span><span style="color:#A6ACCD;"> t</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#89DDFF;font-style:italic;">break</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> sink</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">asMono</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><p>At this point, the processing flow of the RPC sender ends.</p><p>In particular, the reason why <code>request ID</code> is not encoded upstream is because some RPC requests may be sent to multiple RPC receivers, such as group messages are often forwarded to multiple turms-gateway services end, and through separate encoding, the byte data transmitted from the upstream can be shared without memory copying, which greatly improves memory usage. This is one of the reasons why Turms develops its own RPC service.</p><h5 id="rpc-receiver-of-handleservicerequest" tabindex="-1">RPC receiver of HandleServiceRequest <a class="header-anchor" href="#rpc-receiver-of-handleservicerequest" aria-label="Permalink to &quot;RPC receiver of HandleServiceRequest&quot;">​</a></h5><p>TODO</p></div></div></main><footer class="VPDocFooter" data-v-c4b0d3cf data-v-face870a><!--[--><!--]--><!----><div class="prev-next" data-v-face870a><div class="pager" data-v-face870a><a class="pager-link prev" href="/docs/server/development/plugin.html" data-v-face870a><span class="desc" data-v-face870a>Previous page</span><span class="title" data-v-face870a>Custom Plugins</span></a></div><div class="has-prev pager" data-v-face870a><a class="pager-link next" href="/docs/server/development/testing.html" data-v-face870a><span class="desc" data-v-face870a>Next page</span><span class="title" data-v-face870a>Testing</span></a></div></div></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"design_schema.md\":\"efa03370\",\"client_quick-start.md\":\"bac4da35\",\"client_requirements.md\":\"ac24b2fa\",\"client_session.md\":\"6404c66b\",\"community_index.md\":\"6ff076ff\",\"design_architecture.md\":\"dbc0e4cc\",\"design_status-aware.md\":\"27f62819\",\"feature_group.md\":\"2fe71513\",\"feature_index.md\":\"cfee6d12\",\"feature_message.md\":\"02efe372\",\"feature_simultaneous-login.md\":\"b27be3af\",\"client_turms-client-js.md\":\"74a7635f\",\"index.md\":\"d6bc2c44\",\"server_development_testing.md\":\"031eacf0\",\"client_api.md\":\"8f0070ea\",\"server_module_chatbot.md\":\"91bf79f1\",\"client_communication-protocol.md\":\"53f934cc\",\"client_metrics.md\":\"1080928b\",\"reference_admin-api.md\":\"89675154\",\"server_module_storage.md\":\"9f80c272\",\"server_module_data-analytics.md\":\"9637df23\",\"server_module_identity-access-management.md\":\"aeb89734\",\"server_module_security.md\":\"d48a3174\",\"server_deployment_getting-started.md\":\"ea354766\",\"server_deployment_config.md\":\"45b0dbc6\",\"zh-cn_server_development_redevelopment.md\":\"b228c24a\",\"zh-cn_server_development_rules.md\":\"a8967b8f\",\"turms-admin.md\":\"95365cef\",\"zh-cn_client_api.md\":\"77e70dd2\",\"zh-cn_client_metrics.md\":\"567914e8\",\"zh-cn_client_quick-start.md\":\"e8d5cf88\",\"zh-cn_client_requirements.md\":\"326d8549\",\"zh-cn_client_session.md\":\"cc2f9526\",\"zh-cn_client_turms-client-js.md\":\"b3c45ee4\",\"zh-cn_community_index.md\":\"e54e8d6c\",\"zh-cn_design_architecture.md\":\"7c93c5fa\",\"zh-cn_design_schema.md\":\"f9704095\",\"zh-cn_design_status-aware.md\":\"02e982b6\",\"zh-cn_feature_group.md\":\"9680e961\",\"zh-cn_feature_index.md\":\"0c97076a\",\"zh-cn_feature_message.md\":\"8365d67b\",\"zh-cn_feature_simultaneous-login.md\":\"eec58c7f\",\"zh-cn_feature_user.md\":\"98693644\",\"zh-cn_index.md\":\"f7ed7940\",\"zh-cn_reference_status-code.md\":\"93beef6e\",\"zh-cn_server_deployment_config.md\":\"69393461\",\"server_development_redevelopment.md\":\"fd676d5a\",\"zh-cn_server_deployment_getting-started.md\":\"bca91df8\",\"zh-cn_server_development_testing.md\":\"fbb2dac5\",\"zh-cn_server_module_anti-spam.md\":\"df44bbf2\",\"zh-cn_server_module_chatbot.md\":\"0ef4c980\",\"zh-cn_server_module_cluster.md\":\"d81b1787\",\"server_module_cluster.md\":\"268f78ff\",\"reference_status-code.md\":\"c298a113\",\"zh-cn_server_module_data-analytics.md\":\"7a0c76a2\",\"zh-cn_server_module_identity-access-management.md\":\"60223284\",\"server_development_plugin.md\":\"7b8edd47\",\"zh-cn_server_module_observability.md\":\"4df2365d\",\"zh-cn_server_module_security.md\":\"7151ce4c\",\"zh-cn_server_module_storage.md\":\"7381be67\",\"zh-cn_server_module_system-resource-management.md\":\"496ebe5e\",\"server_module_observability.md\":\"c4c9204e\",\"feature_user.md\":\"b75bb87f\",\"zh-cn_turms-admin.md\":\"1f9ebfcf\",\"server_development_code.md\":\"07c8719f\",\"server_module_anti-spam.md\":\"8a45ca95\",\"server_deployment_distribution.md\":\"11acc723\",\"server_development_rules.md\":\"230f8b60\",\"zh-cn_reference_admin-api.md\":\"651c7516\",\"zh-cn_server_deployment_distribution.md\":\"3d9010e0\",\"zh-cn_server_development_code.md\":\"bed825d4\",\"zh-cn_server_development_plugin.md\":\"303552d1\",\"server_module_system-resource-management.md\":\"0d87c49f\"}")
__VP_SITE_DATA__ = JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"Turms Documentation\",\"description\":\"A VitePress site\",\"base\":\"/docs/\",\"head\":[],\"appearance\":true,\"themeConfig\":{\"logo\":\"https://raw.githubusercontent.com/turms-im/assets/master/logo/pegion.svg\",\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/turms-im/turms\"}],\"search\":{\"provider\":\"algolia\",\"options\":{\"appId\":\"WV3XO0QV2E\",\"apiKey\":\"f7a7c652875d1f2cc0f0ec52d8f8f660\",\"indexName\":\"turms-imio\",\"locales\":{\"zh-CN\":{\"placeholder\":\"搜索\",\"translations\":{\"button\":{\"buttonText\":\"搜索\",\"buttonAriaLabel\":\"搜索\"},\"modal\":{\"searchBox\":{\"resetButtonTitle\":\"重置查询\",\"resetButtonAriaLabel\":\"重置查询\",\"cancelButtonText\":\"取消\",\"cancelButtonAriaLabel\":\"取消\"},\"startScreen\":{\"recentSearchesTitle\":\"搜索历史\",\"noRecentSearchesText\":\"没有搜索历史\",\"saveRecentSearchButtonTitle\":\"保存至搜索历史\",\"removeRecentSearchButtonTitle\":\"从搜索历史中移除\",\"favoriteSearchesTitle\":\"收藏\",\"removeFavoriteSearchButtonTitle\":\"从收藏中移除\"},\"errorScreen\":{\"titleText\":\"无法获取搜索结果\",\"helpText\":\"请检查网络连接\"},\"footer\":{\"selectText\":\"选择\",\"navigateText\":\"切换\",\"closeText\":\"关闭\",\"searchByText\":\"搜索提供者\"},\"noResultsScreen\":{\"noResultsText\":\"没有找到相关结果\",\"suggestedQueryText\":\"您可能想搜索\",\"reportMissingResultsLinkText\":\"点击反馈\",\"reportMissingResultsText\":\"没有找到结果？请报告缺失\"}}}}}}}},\"locales\":{\"root\":{\"label\":\"English\",\"lang\":\"en\",\"themeConfig\":{\"sidebar\":[{\"text\":\"Introduction\",\"link\":\"/index.md\"},{\"text\":\"Community FAQ\",\"link\":\"/community/index.md\"},{\"text\":\"Business Features\",\"collapsed\":true,\"items\":[{\"text\":\"Business Features\",\"link\":\"/feature/index.md\"},{\"text\":\"Simultaneous Login\",\"link\":\"/feature/simultaneous-login.md\"},{\"text\":\"User-related Features\",\"link\":\"/feature/user.md\"},{\"text\":\"Group-related Features\",\"link\":\"/feature/group.md\"},{\"text\":\"Message-related Features\",\"link\":\"/feature/message.md\"}]},{\"text\":\"Design\",\"collapsed\":true,\"items\":[{\"text\":\"Architecture Design\",\"link\":\"/design/architecture.md\"},{\"text\":\"Collection Schema Design\",\"link\":\"/design/schema.md\"},{\"text\":\"Status Awareness\",\"link\":\"/design/status-aware.md\"}]},{\"text\":\"Server Guide\",\"collapsed\":true,\"items\":[{\"text\":\"Deployment\",\"items\":[{\"text\":\"Build and Start\",\"link\":\"/server/deployment/getting-started.md\"},{\"text\":\"Distribution\",\"link\":\"/server/deployment/distribution.md\"},{\"text\":\"Configuration\",\"link\":\"/server/deployment/config.md\"}]},{\"text\":\"Development\",\"items\":[{\"text\":\"About Secondary Development\",\"link\":\"/server/development/redevelopment.md\"},{\"text\":\"Basic Development Rules\",\"link\":\"/server/development/rules.md\"},{\"text\":\"Custom Plugins\",\"link\":\"/server/development/plugin.md\"},{\"text\":\"Source Code\",\"link\":\"/server/development/code.md\"},{\"text\":\"Testing\",\"link\":\"/server/development/testing.md\"}]},{\"text\":\"Main Modules\",\"items\":[{\"text\":\"Identity and Access Management\",\"link\":\"/server/module/identity-access-management.md\"},{\"text\":\"Cluster Design and Implementation\",\"link\":\"/server/module/cluster.md\"},{\"text\":\"System Resource Management\",\"link\":\"/server/module/system-resource-management.md\"},{\"text\":\"Observability\",\"link\":\"/server/module/observability.md\"},{\"text\":\"Security\",\"link\":\"/server/module/security.md\"},{\"text\":\"Storage Service\",\"link\":\"/server/module/storage.md\"},{\"text\":\"Chatbot\",\"link\":\"/server/module/chatbot.md\"},{\"text\":\"Content Moderation\",\"link\":\"/server/module/anti-spam.md\"},{\"text\":\"Data Analysis\",\"link\":\"/server/module/data-analytics.md\"}]}]},{\"text\":\"Client Guide\",\"collapsed\":true,\"items\":[{\"text\":\"Quick Start\",\"link\":\"/client/quick-start.md\"},{\"text\":\"Version Requirements\",\"link\":\"/client/requirements.md\"},{\"text\":\"API\",\"link\":\"/client/api.md\"},{\"text\":\"Session Lifecycle\",\"link\":\"/client/session.md\"},{\"text\":\"Metrics\",\"link\":\"/client/metrics.md\"},{\"text\":\"Communication Protocol Used Between Client and Server\",\"link\":\"/client/communication-protocol.md\"},{\"text\":\"turms-client-js Shared Context\",\"link\":\"/client/turms-client-js.md\"}]},{\"text\":\"turms-admin\",\"link\":\"/turms-admin.md\"},{\"text\":\"Reference\",\"collapsed\":true,\"items\":[{\"text\":\"Admin API\",\"link\":\"/reference/admin-api.md\"},{\"text\":\"Status Code\",\"link\":\"/reference/status-code.md\"}]}]}},\"zh-CN\":{\"label\":\"简体中文\",\"lang\":\"zh-CN\",\"themeConfig\":{\"lastUpdatedText\":\"上次更新\",\"outline\":{\"label\":\"当前页\"},\"docFooter\":{\"prev\":\"上一页\",\"next\":\"下一页\"},\"sidebar\":[{\"text\":\"介绍\",\"link\":\"/zh-CN/index.md\"},{\"text\":\"社区常见问题\",\"link\":\"/zh-CN/community/index.md\"},{\"text\":\"业务功能\",\"collapsed\":true,\"items\":[{\"text\":\"业务功能介绍\",\"link\":\"/zh-CN/feature/index.md\"},{\"text\":\"多端登录\",\"link\":\"/zh-CN/feature/simultaneous-login.md\"},{\"text\":\"用户相关功能\",\"link\":\"/zh-CN/feature/user.md\"},{\"text\":\"群组相关功能\",\"link\":\"/zh-CN/feature/group.md\"},{\"text\":\"消息相关功能\",\"link\":\"/zh-CN/feature/message.md\"}]},{\"text\":\"设计\",\"collapsed\":true,\"items\":[{\"text\":\"架构设计\",\"link\":\"/zh-CN/design/architecture.md\"},{\"text\":\"集合结构设计\",\"link\":\"/zh-CN/design/schema.md\"},{\"text\":\"状态感知\",\"link\":\"/zh-CN/design/status-aware.md\"}]},{\"text\":\"服务端指南\",\"collapsed\":true,\"items\":[{\"text\":\"部署\",\"items\":[{\"text\":\"搭建与启动\",\"link\":\"/zh-CN/server/deployment/getting-started.md\"},{\"text\":\"发布\",\"link\":\"/zh-CN/server/deployment/distribution.md\"},{\"text\":\"配置参数\",\"link\":\"/zh-CN/server/deployment/config.md\"}]},{\"text\":\"开发\",\"items\":[{\"text\":\"关于二次开发\",\"link\":\"/zh-CN/server/development/redevelopment.md\"},{\"text\":\"基本开发规约\",\"link\":\"/zh-CN/server/development/rules.md\"},{\"text\":\"自定义插件\",\"link\":\"/zh-CN/server/development/plugin.md\"},{\"text\":\"源码\",\"link\":\"/zh-CN/server/development/code.md\"},{\"text\":\"测试\",\"link\":\"/zh-CN/server/development/testing.md\"}]},{\"text\":\"主要模块\",\"items\":[{\"text\":\"身份与访问管理\",\"link\":\"/zh-CN/server/module/identity-access-management.md\"},{\"text\":\"集群的设计与实现\",\"link\":\"/zh-CN/server/module/cluster.md\"},{\"text\":\"系统资源管理\",\"link\":\"/zh-CN/server/module/system-resource-management.md\"},{\"text\":\"可观测性体系\",\"link\":\"/zh-CN/server/module/observability.md\"},{\"text\":\"安全\",\"link\":\"/zh-CN/server/module/security.md\"},{\"text\":\"存储服务\",\"link\":\"/zh-CN/server/module/storage.md\"},{\"text\":\"聊天机器人\",\"link\":\"/zh-CN/server/module/chatbot.md\"},{\"text\":\"敏感词过滤\",\"link\":\"/zh-CN/server/module/anti-spam.md\"},{\"text\":\"数据分析\",\"link\":\"/zh-CN/server/module/data-analytics.md\"}]}]},{\"text\":\"客户端指南\",\"collapsed\":true,\"items\":[{\"text\":\"Quick Start\",\"link\":\"/zh-CN/client/quick-start.md\"},{\"text\":\"版本要求\",\"link\":\"/zh-CN/client/requirements.md\"},{\"text\":\"接口\",\"link\":\"/zh-CN/client/api.md\"},{\"text\":\"会话的生命周期\",\"link\":\"/zh-CN/client/session.md\"},{\"text\":\"度量数据\",\"link\":\"/zh-CN/client/metrics.md\"},{\"text\":\"与服务端通信时使用的数据格式\",\"link\":\"/zh-CN/client/communication-protocol.md\"},{\"text\":\"turms-client-js共享上下文\",\"link\":\"/zh-CN/client/turms-client-js.md\"}]},{\"text\":\"turms-admin\",\"link\":\"/zh-CN/turms-admin.md\"},{\"text\":\"手册\",\"collapsed\":true,\"items\":[{\"text\":\"管理员API接口\",\"link\":\"/zh-CN/reference/admin-api.md\"},{\"text\":\"状态码\",\"link\":\"/zh-CN/reference/status-code.md\"}]}]}}},\"scrollOffset\":90,\"cleanUrls\":false}")</script>
    
  </body>
</html>